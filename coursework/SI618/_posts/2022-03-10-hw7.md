---
layout: single
title: "HW7. Machine Learning 2: Classification"
permalink: /coursework/SI618/hw7/
comments: false
author_profile: true
read_time: true
toc: true
toc_label: "Table of Contents"
toc_sticky: true
categories: ["SI618"]
---

**Topics: K-NN, Linear SVM, RBF SVM, Gaussian process classifier, Decision tree classifier, Randomforest classifer, Neural network, AdaBoost classifer, Gaussian naive bayes classifer, PCA, t-SNE**

--- 

This is, perhaps, one of the most exciting homework assignments that you have
encountered in this course!

You are going to try your hand at a Kaggle competition to predict Titanic survivorship.
(Recall that we've played with Titanic data earlier in this course -- this data set is
slightly different.)

(NOTE: if you prefer to not submit your work to the Kaggle competition that's fine --
just contact Chris via email (cteplovs@umich.edu) and we will work out an alternative.)

To start with, make sure you have a [Kaggle](https://www.kaggle.com/) account, 
then navigate to the [Titanic: Machine Learning from Disaster](https://www.kaggle.com/c/titanic/overview) project page.

We'll view the [introductory video](https://www.youtube.com/watch?v=8yZMXCaFshs) 
together in class.

The basic steps for this assignment are outlined in the video:

1. Accept the rules and join the competition
2. Download the data (from the data tab of the competition page)
3. Understand the problem
4. EDA (Exploratory Data Analysis)
5. Train, tune, and ensemble (!) your machine learning models
6. Upload your prediction as a submission on Kaggle and receive an accuracy score

additionally, you will

7. Upload your final notebook to Canvas and report your best accuracy score.  

Note that class grades are not entirely dependent on your accuracy score.  
All models that achieve 75% accuracy will receive full points for 
the accuracy component of this assignment.

Rubric:

1. (20 points) EDA
2. (60 points) Train, tune, and ensemble machine learning models
3. (10 points) Accuracy score based on Kaggle submission report (or alternative, see NOTE above).
4. (10 points) PEP-8, grammar, spelling, style, etc.

Some additional notes:

1. If you use another notebook, code, or approaches be sure to reference the original work. (Note that we recommend you study existing Kaggle notebooks before starting your own work.)
2. You can help each other but in the end you must submit your own work, both to Kaggle and to Canvas.

Some additional resources:

* "ensemble" your models with a [VotingClassifier](https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.VotingClassifier.html)
* a good primer on [feature engineering](https://triangleinequality.wordpress.com/2013/09/08/basic-feature-engineering-with-the-titanic-data/)
* There are a lot of good [notebooks to study](https://www.kaggle.com/c/titanic/notebooks) (check the number of upvotes to help guide your exploration)

(and don't cheat)

One final note:  Your submission should be a self-contained notebook that is NOT based
on this one.  Studying the existing Kaggle competition notebooks should 
give you a sense of what makes a "good" notebook.


```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import matplotlib.patches as mpatches
import plotly.graph_objects as gp
from sklearn.model_selection import train_test_split
from sklearn.pipeline import Pipeline
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.impute import SimpleImputer
from sklearn.compose import ColumnTransformer
from sklearn.model_selection import cross_validate
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error
import statistics
from sklearn.neural_network import MLPClassifier
from sklearn.neighbors import KNeighborsClassifier
from sklearn.svm import SVC
from sklearn.gaussian_process import GaussianProcessClassifier
from sklearn.gaussian_process.kernels import RBF
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import RandomForestClassifier, AdaBoostClassifier, VotingClassifier
from sklearn.naive_bayes import GaussianNB
from sklearn.discriminant_analysis import QuadraticDiscriminantAnalysis
from sklearn.decomposition import PCA
from sklearn.manifold import TSNE
from sklearn.model_selection import GridSearchCV
from sklearn.gaussian_process.kernels import RBF
from sklearn.gaussian_process.kernels import DotProduct
from sklearn.gaussian_process.kernels import Matern
from sklearn.gaussian_process.kernels import RationalQuadratic
from sklearn.gaussian_process.kernels import WhiteKernel
import warnings
```


```python
warnings.filterwarnings("ignore")
```


```python
sns.set(style = "darkgrid")
```

# 1. EDA


```python
titanic = pd.read_csv("./data/titanic_train.csv")
```


```python
titanic.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PassengerId</th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div>



There is a total of 12 columns, but since PassengerId is just an ID, so let's delete the column.


```python
titanic_id = titanic["PassengerId"]
titanic.drop("PassengerId", axis = 1, inplace = True)
titanic.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div>



There are 10 independent variables and 1 dependent variable.
- Dependent variable: Survived
- Independent variables:
    - Pclass: Ticket class. (1 = 1st, 2 = 2nd, 3 = 3rd)
    - Name
    - Sex
    - Age
    - SibSp: # of siblings / spouses aboard the Titanic
    - Parch: # of parents / children aboard the Titanic
    - Ticket: Ticket numberc
    - Fare: Passenger fare
    - Cabin: Cabin number
    - Embarked: Port of Embarkation (C = Cherbourg, Q = Queenstown, S = Southampton)

And we can categorize independent variables into 3 different categories:     
- Ticket related columns: Pclass, Ticket, Fare, Cabin, Embarked       
- Person related columns: Name, Sex, Age      
- Family related columns: SibSp, Parch       

## 1.0. Change column names

For just convenience, let's change the column names.

- Dependent variable: Survived -> is_survived
- Independent variables:
    - Pclass: Ticket class. (1 = 1st, 2 = 2nd, 3 = 3rd) -> p_class
    - Name -> name
    - Sex -> sex
    - Age -> age
    - SibSp: # of siblings / spouses aboard the Titanic -> num_sb_sp
    - Parch: # of parents / children aboard the Titanic -> num_pr_ch
    - Ticket: Ticket number -> ticket_number
    - Fare: Passenger fare -> ticket_fare
    - Cabin: Cabin number -> cabin_number
    - Embarked: Port of Embarkation (C = Cherbourg, Q = Queenstown, S = Southampton) -> embark_port


```python
titanic.rename(columns = {"Survived" : "is_survived", 
                          "Pclass" : "p_class",
                          "Name" : "name",
                          "Sex" : "sex", 
                          "Age" : "age",
                          "SibSp" : "num_sb_sp",
                          "Parch" : "num_pr_ch",
                          "Ticket" : "ticket_number",
                          "Fare" : "ticket_fare",
                          "Cabin" : "cabin_number",
                          "Embarked" : "embark_port"}, inplace = True)
titanic.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div>



## 1.1. Check missing values


```python
np.sum(titanic.isnull(), axis = 0).sort_values(ascending = False)
```




    cabin_number     687
    age              177
    embark_port        2
    is_survived        0
    p_class            0
    name               0
    sex                0
    num_sb_sp          0
    num_pr_ch          0
    ticket_number      0
    ticket_fare        0
    dtype: int64



- Almost every row doesn't have a cabin_number value.
- age is the next most missing column.
- embark_port only has 2 missing values.


## 1.1. Ticket related columns: p_class, ticket_number, ticket_fare, cabin_number, embark_port

**p_class**


```python
titanic["p_class"].value_counts()
```




    3    491
    1    216
    2    184
    Name: p_class, dtype: int64



- 1st class passengers: 216
- 2nd class passengers: 184
- 3rd class passengers: 491


```python
np.sum(titanic["p_class"].isnull())
```




    0



- There is no missing value in the p_class column

**p_class ~ is_survived**

Let's check the relationship between p_class and is_survived.


```python
p_class_is_survived = titanic.groupby(["p_class","is_survived"]).count().name.unstack().reset_index()
p_class_is_survived = p_class_is_survived.rename_axis(None, axis = 1)
p_class_is_survived["total"] = p_class_is_survived[0] + p_class_is_survived[1]
p_class_is_survived["ratio"] = np.round(p_class_is_survived[1] / p_class_is_survived.total, 2)
p_class_is_survived
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>0</th>
      <th>1</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>80</td>
      <td>136</td>
      <td>216</td>
      <td>0.63</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>97</td>
      <td>87</td>
      <td>184</td>
      <td>0.47</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>372</td>
      <td>119</td>
      <td>491</td>
      <td>0.24</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))

# bar graph for total students
color = "darkblue"
ax1 = sns.barplot(x = "p_class", y = "total", color = color, alpha = 0.8, \
                  data = p_class_is_survived)
top_bar = mpatches.Patch(color = color, label = 'Num of total passengers')

# bar graph for students have research experience
color = "lightblue"
ax2 = sns.barplot(x = "p_class", y = 1,  color = color, alpha = 0.8, \
                  data = p_class_is_survived)
ax2.set_xlabel("Passenger class", fontsize = 16)
ax2.set_ylabel("Number of passengers", fontsize = 16)
low_bar = mpatches.Patch(color = color, label = 'Num of survived passengers')

# ratio
plt.text(s = "63%", x = -0.05, y = 110, fontsize = 16)
plt.text(s = "47%", x = 0.95, y = 60, fontsize = 16)
plt.text(s = "24%", x = 1.95, y = 92, fontsize = 16)

plt.legend(handles=[top_bar, low_bar])
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_28_0.png)
    


- As the class goes up one level, the chance of surviving increases by about 1.5 times.              
    -> passenger class is important in predicting survival

**ticket_number**


```python
np.sum(titanic["ticket_number"].isnull())
```




    0



- There is no missing value in the ticket_number column


```python
titanic.ticket_number
```




    0             A/5 21171
    1              PC 17599
    2      STON/O2. 3101282
    3                113803
    4                373450
                 ...       
    886              211536
    887              112053
    888          W./C. 6607
    889              111369
    890              370376
    Name: ticket_number, Length: 891, dtype: object



- Ticket numbers have a form of alphabet + number or just number.      
    -> Let's divide the ticket number into ticket_number_alphabet and ticket_number_number.


```python
titanic.loc[titanic["ticket_number"].str.split(" ").str[1].isnull() == False, "ticket_number_alphabet"] = titanic[titanic["ticket_number"].str.split(" ").str[1].isnull() == False].ticket_number.str.split(" ").str[0]
titanic["ticket_number_alphabet"] = titanic.ticket_number_alphabet.fillna("non")
```


```python
titanic.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
      <td>A/5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
      <td>PC</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
      <td>STON/O2.</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
      <td>non</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
    </tr>
  </tbody>
</table>
</div>




```python
titanic.loc[titanic.ticket_number_alphabet == "non", "ticket_number_number"] = titanic[titanic.ticket_number_alphabet == "non"]["ticket_number"].str.split(" ").str[0]
titanic.loc[titanic.ticket_number_alphabet != "non", "ticket_number_number"] = titanic[titanic.ticket_number_alphabet != "non"]["ticket_number"].str.split(" ").str[1]
titanic.loc[titanic.ticket_number.str.split(" ").str[2].isnull() == False, "ticket_number_number"] = titanic[titanic.ticket_number.str.split(" ").str[2].isnull() == False].ticket_number.str.split(" ").str[2]
```


```python
titanic[["ticket_number", "ticket_number_alphabet", "ticket_number_number"]]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticket_number</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>A/5 21171</td>
      <td>A/5</td>
      <td>21171</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PC 17599</td>
      <td>PC</td>
      <td>17599</td>
    </tr>
    <tr>
      <th>2</th>
      <td>STON/O2. 3101282</td>
      <td>STON/O2.</td>
      <td>3101282</td>
    </tr>
    <tr>
      <th>3</th>
      <td>113803</td>
      <td>non</td>
      <td>113803</td>
    </tr>
    <tr>
      <th>4</th>
      <td>373450</td>
      <td>non</td>
      <td>373450</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>886</th>
      <td>211536</td>
      <td>non</td>
      <td>211536</td>
    </tr>
    <tr>
      <th>887</th>
      <td>112053</td>
      <td>non</td>
      <td>112053</td>
    </tr>
    <tr>
      <th>888</th>
      <td>W./C. 6607</td>
      <td>W./C.</td>
      <td>6607</td>
    </tr>
    <tr>
      <th>889</th>
      <td>111369</td>
      <td>non</td>
      <td>111369</td>
    </tr>
    <tr>
      <th>890</th>
      <td>370376</td>
      <td>non</td>
      <td>370376</td>
    </tr>
  </tbody>
</table>
<p>891 rows × 3 columns</p>
</div>



Aslo, if we sort the data by ticket number, 


```python
titanic.sort_values("ticket_number")
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>504</th>
      <td>1</td>
      <td>1</td>
      <td>Maioni, Miss. Roberta</td>
      <td>female</td>
      <td>16.0</td>
      <td>0</td>
      <td>0</td>
      <td>110152</td>
      <td>86.500</td>
      <td>B79</td>
      <td>S</td>
      <td>non</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>257</th>
      <td>1</td>
      <td>1</td>
      <td>Cherry, Miss. Gladys</td>
      <td>female</td>
      <td>30.0</td>
      <td>0</td>
      <td>0</td>
      <td>110152</td>
      <td>86.500</td>
      <td>B77</td>
      <td>S</td>
      <td>non</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>759</th>
      <td>1</td>
      <td>1</td>
      <td>Rothes, the Countess. of (Lucy Noel Martha Dye...</td>
      <td>female</td>
      <td>33.0</td>
      <td>0</td>
      <td>0</td>
      <td>110152</td>
      <td>86.500</td>
      <td>B77</td>
      <td>S</td>
      <td>non</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>262</th>
      <td>0</td>
      <td>1</td>
      <td>Taussig, Mr. Emil</td>
      <td>male</td>
      <td>52.0</td>
      <td>1</td>
      <td>1</td>
      <td>110413</td>
      <td>79.650</td>
      <td>E67</td>
      <td>S</td>
      <td>non</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>558</th>
      <td>1</td>
      <td>1</td>
      <td>Taussig, Mrs. Emil (Tillie Mandelbaum)</td>
      <td>female</td>
      <td>39.0</td>
      <td>1</td>
      <td>1</td>
      <td>110413</td>
      <td>79.650</td>
      <td>E67</td>
      <td>S</td>
      <td>non</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>235</th>
      <td>0</td>
      <td>3</td>
      <td>Harknett, Miss. Alice Phoebe</td>
      <td>female</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>W./C. 6609</td>
      <td>7.550</td>
      <td>NaN</td>
      <td>S</td>
      <td>W./C.</td>
      <td>6609</td>
    </tr>
    <tr>
      <th>92</th>
      <td>0</td>
      <td>1</td>
      <td>Chaffee, Mr. Herbert Fuller</td>
      <td>male</td>
      <td>46.0</td>
      <td>1</td>
      <td>0</td>
      <td>W.E.P. 5734</td>
      <td>61.175</td>
      <td>E31</td>
      <td>S</td>
      <td>W.E.P.</td>
      <td>5734</td>
    </tr>
    <tr>
      <th>219</th>
      <td>0</td>
      <td>2</td>
      <td>Harris, Mr. Walter</td>
      <td>male</td>
      <td>30.0</td>
      <td>0</td>
      <td>0</td>
      <td>W/C 14208</td>
      <td>10.500</td>
      <td>NaN</td>
      <td>S</td>
      <td>W/C</td>
      <td>14208</td>
    </tr>
    <tr>
      <th>540</th>
      <td>1</td>
      <td>1</td>
      <td>Crosby, Miss. Harriet R</td>
      <td>female</td>
      <td>36.0</td>
      <td>0</td>
      <td>2</td>
      <td>WE/P 5735</td>
      <td>71.000</td>
      <td>B22</td>
      <td>S</td>
      <td>WE/P</td>
      <td>5735</td>
    </tr>
    <tr>
      <th>745</th>
      <td>0</td>
      <td>1</td>
      <td>Crosby, Capt. Edward Gifford</td>
      <td>male</td>
      <td>70.0</td>
      <td>1</td>
      <td>1</td>
      <td>WE/P 5735</td>
      <td>71.000</td>
      <td>B22</td>
      <td>S</td>
      <td>WE/P</td>
      <td>5735</td>
    </tr>
  </tbody>
</table>
<p>891 rows × 13 columns</p>
</div>



- then it seems that rows that have the same ticket number have the same ticket fare. Let's check this hypothesis for all rows.


```python
merged_by_ticket_number = titanic.merge(titanic, on = "ticket_number", how = "left")
merged_by_ticket_number[merged_by_ticket_number.ticket_fare_x != merged_by_ticket_number.ticket_fare_y]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived_x</th>
      <th>p_class_x</th>
      <th>name_x</th>
      <th>sex_x</th>
      <th>age_x</th>
      <th>num_sb_sp_x</th>
      <th>num_pr_ch_x</th>
      <th>ticket_number</th>
      <th>ticket_fare_x</th>
      <th>cabin_number_x</th>
      <th>...</th>
      <th>name_y</th>
      <th>sex_y</th>
      <th>age_y</th>
      <th>num_sb_sp_y</th>
      <th>num_pr_ch_y</th>
      <th>ticket_fare_y</th>
      <th>cabin_number_y</th>
      <th>embark_port_y</th>
      <th>ticket_number_alphabet_y</th>
      <th>ticket_number_number_y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>248</th>
      <td>0</td>
      <td>3</td>
      <td>Osen, Mr. Olaf Elon</td>
      <td>male</td>
      <td>16.0</td>
      <td>0</td>
      <td>0</td>
      <td>7534</td>
      <td>9.2167</td>
      <td>NaN</td>
      <td>...</td>
      <td>Gustafsson, Mr. Alfred Ossian</td>
      <td>male</td>
      <td>20.0</td>
      <td>0</td>
      <td>0</td>
      <td>9.8458</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>7534</td>
    </tr>
    <tr>
      <th>1570</th>
      <td>0</td>
      <td>3</td>
      <td>Gustafsson, Mr. Alfred Ossian</td>
      <td>male</td>
      <td>20.0</td>
      <td>0</td>
      <td>0</td>
      <td>7534</td>
      <td>9.8458</td>
      <td>NaN</td>
      <td>...</td>
      <td>Osen, Mr. Olaf Elon</td>
      <td>male</td>
      <td>16.0</td>
      <td>0</td>
      <td>0</td>
      <td>9.2167</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>7534</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 25 columns</p>
</div>



- There are only 2 people who have the same ticket number but have different ticket fares. So, I think this case is just an outlier, and we can think that if the ticket number is the same, then the ticket fare is also the same.

If we check some cases that have the same ticket number,


```python
merged_by_ticket_number[["name_x", "name_y", "ticket_fare_x", "ticket_fare_y", "ticket_number"]].sort_values(["ticket_number", "name_x"]).head(20)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name_x</th>
      <th>name_y</th>
      <th>ticket_fare_x</th>
      <th>ticket_fare_y</th>
      <th>ticket_number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>460</th>
      <td>Cherry, Miss. Gladys</td>
      <td>Cherry, Miss. Gladys</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>461</th>
      <td>Cherry, Miss. Gladys</td>
      <td>Maioni, Miss. Roberta</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>462</th>
      <td>Cherry, Miss. Gladys</td>
      <td>Rothes, the Countess. of (Lucy Noel Martha Dye...</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>889</th>
      <td>Maioni, Miss. Roberta</td>
      <td>Cherry, Miss. Gladys</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>890</th>
      <td>Maioni, Miss. Roberta</td>
      <td>Maioni, Miss. Roberta</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>891</th>
      <td>Maioni, Miss. Roberta</td>
      <td>Rothes, the Countess. of (Lucy Noel Martha Dye...</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>1345</th>
      <td>Rothes, the Countess. of (Lucy Noel Martha Dye...</td>
      <td>Cherry, Miss. Gladys</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>1346</th>
      <td>Rothes, the Countess. of (Lucy Noel Martha Dye...</td>
      <td>Maioni, Miss. Roberta</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>1347</th>
      <td>Rothes, the Countess. of (Lucy Noel Martha Dye...</td>
      <td>Rothes, the Countess. of (Lucy Noel Martha Dye...</td>
      <td>86.50</td>
      <td>86.50</td>
      <td>110152</td>
    </tr>
    <tr>
      <th>1026</th>
      <td>Taussig, Miss. Ruth</td>
      <td>Taussig, Mr. Emil</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>1027</th>
      <td>Taussig, Miss. Ruth</td>
      <td>Taussig, Mrs. Emil (Tillie Mandelbaum)</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>1028</th>
      <td>Taussig, Miss. Ruth</td>
      <td>Taussig, Miss. Ruth</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>473</th>
      <td>Taussig, Mr. Emil</td>
      <td>Taussig, Mr. Emil</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>474</th>
      <td>Taussig, Mr. Emil</td>
      <td>Taussig, Mrs. Emil (Tillie Mandelbaum)</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>475</th>
      <td>Taussig, Mr. Emil</td>
      <td>Taussig, Miss. Ruth</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>987</th>
      <td>Taussig, Mrs. Emil (Tillie Mandelbaum)</td>
      <td>Taussig, Mr. Emil</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>988</th>
      <td>Taussig, Mrs. Emil (Tillie Mandelbaum)</td>
      <td>Taussig, Mrs. Emil (Tillie Mandelbaum)</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>989</th>
      <td>Taussig, Mrs. Emil (Tillie Mandelbaum)</td>
      <td>Taussig, Miss. Ruth</td>
      <td>79.65</td>
      <td>79.65</td>
      <td>110413</td>
    </tr>
    <tr>
      <th>842</th>
      <td>Clifford, Mr. George Quincy</td>
      <td>Porter, Mr. Walter Chamberlain</td>
      <td>52.00</td>
      <td>52.00</td>
      <td>110465</td>
    </tr>
    <tr>
      <th>843</th>
      <td>Clifford, Mr. George Quincy</td>
      <td>Clifford, Mr. George Quincy</td>
      <td>52.00</td>
      <td>52.00</td>
      <td>110465</td>
    </tr>
  </tbody>
</table>
</div>



- then we can infer that peoples who have the same ticket number are companions who were traveling together. Since if companions are not family members, then this information is not in the num_sb_sp and num_pr_ch columns.     
    -> let's make a new column that shows how many companions were there for each passenger based on ticket number.


```python
titanic = titanic.merge(titanic["ticket_number"].value_counts().reset_index().rename(columns = {"index" : "ticket_number", "ticket_number" : "num_cmp_by_ticket"}), \
                        on = "ticket_number", how = "left")
titanic["num_cmp_by_ticket"] = titanic["num_cmp_by_ticket"] - 1 # only one passenger with no companion has to have value 0
titanic.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp_by_ticket</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
      <td>A/5</td>
      <td>21171</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
      <td>PC</td>
      <td>17599</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
      <td>STON/O2.</td>
      <td>3101282</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
      <td>non</td>
      <td>113803</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>373450</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>



- But this can be different from the result from the sum of num_sb_sp and num_pr_ch.    
    -> let's cacluate num_cmp_by_sb_sp_pr_ch and compare this value to num_cmp_by_ticket.


```python
titanic["num_cmp_by_sb_sp_pr_ch"] = titanic["num_sb_sp"] + titanic["num_pr_ch"]
titanic[titanic.num_cmp_by_ticket != titanic.num_cmp_by_sb_sp_pr_ch]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp_by_ticket</th>
      <th>num_cmp_by_sb_sp_pr_ch</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
      <td>A/5</td>
      <td>21171</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
      <td>PC</td>
      <td>17599</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>3</td>
      <td>Palsson, Master. Gosta Leonard</td>
      <td>male</td>
      <td>2.0</td>
      <td>3</td>
      <td>1</td>
      <td>349909</td>
      <td>21.0750</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>349909</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1</td>
      <td>3</td>
      <td>Sandstrom, Miss. Marguerite Rut</td>
      <td>female</td>
      <td>4.0</td>
      <td>1</td>
      <td>1</td>
      <td>PP 9549</td>
      <td>16.7000</td>
      <td>G6</td>
      <td>S</td>
      <td>PP</td>
      <td>9549</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0</td>
      <td>3</td>
      <td>Rice, Master. Eugene</td>
      <td>male</td>
      <td>2.0</td>
      <td>4</td>
      <td>1</td>
      <td>382652</td>
      <td>29.1250</td>
      <td>NaN</td>
      <td>Q</td>
      <td>non</td>
      <td>382652</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>866</th>
      <td>1</td>
      <td>2</td>
      <td>Duran y More, Miss. Asuncion</td>
      <td>female</td>
      <td>27.0</td>
      <td>1</td>
      <td>0</td>
      <td>SC/PARIS 2149</td>
      <td>13.8583</td>
      <td>NaN</td>
      <td>C</td>
      <td>SC/PARIS</td>
      <td>2149</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>871</th>
      <td>1</td>
      <td>1</td>
      <td>Beckwith, Mrs. Richard Leonard (Sallie Monypeny)</td>
      <td>female</td>
      <td>47.0</td>
      <td>1</td>
      <td>1</td>
      <td>11751</td>
      <td>52.5542</td>
      <td>D35</td>
      <td>S</td>
      <td>non</td>
      <td>11751</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>876</th>
      <td>0</td>
      <td>3</td>
      <td>Gustafsson, Mr. Alfred Ossian</td>
      <td>male</td>
      <td>20.0</td>
      <td>0</td>
      <td>0</td>
      <td>7534</td>
      <td>9.8458</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>7534</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>885</th>
      <td>0</td>
      <td>3</td>
      <td>Rice, Mrs. William (Margaret Norton)</td>
      <td>female</td>
      <td>39.0</td>
      <td>0</td>
      <td>5</td>
      <td>382652</td>
      <td>29.1250</td>
      <td>NaN</td>
      <td>Q</td>
      <td>non</td>
      <td>382652</td>
      <td>4</td>
      <td>5</td>
    </tr>
    <tr>
      <th>888</th>
      <td>0</td>
      <td>3</td>
      <td>Johnston, Miss. Catherine Helen "Carrie"</td>
      <td>female</td>
      <td>NaN</td>
      <td>1</td>
      <td>2</td>
      <td>W./C. 6607</td>
      <td>23.4500</td>
      <td>NaN</td>
      <td>S</td>
      <td>W./C.</td>
      <td>6607</td>
      <td>1</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
<p>288 rows × 15 columns</p>
</div>



- There are 288 cases where the number of companions based on ticket number is different from the number of companions based on num_sb_sp and num_pr_ch.    
    -> Let's make num_cmp =  max(num_cmp_by_ticket, num_cmp_by_sb_sp_pr_ch)


```python
titanic["num_cmp"] = titanic[["num_cmp_by_ticket", "num_cmp_by_sb_sp_pr_ch"]].max(axis = 1)
titanic.drop(["num_cmp_by_ticket", "num_cmp_by_sb_sp_pr_ch"], axis = 1, inplace = True)

titanic.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
      <td>A/5</td>
      <td>21171</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
      <td>PC</td>
      <td>17599</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
      <td>STON/O2.</td>
      <td>3101282</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
      <td>non</td>
      <td>113803</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>373450</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
titanic.shape
```




    (891, 14)



**ticket_number_alphabet**


```python
len(titanic.ticket_number_alphabet.unique())
```




    43




```python
titanic.ticket_number_alphabet.value_counts()
```




    non           665
    PC             60
    C.A.           27
    STON/O         12
    A/5            10
    W./C.           9
    CA.             8
    SOTON/O.Q.      8
    SOTON/OQ        7
    A/5.            7
    CA              6
    STON/O2.        6
    C               5
    F.C.C.          5
    S.O.C.          5
    SC/PARIS        5
    SC/Paris        4
    S.O./P.P.       3
    PP              3
    A/4.            3
    A/4             3
    SC/AH           3
    A./5.           2
    SOTON/O2        2
    A.5.            2
    WE/P            2
    S.C./PARIS      2
    P/PP            2
    F.C.            1
    SC              1
    S.W./PP         1
    A/S             1
    Fa              1
    SCO/W           1
    SW/PP           1
    W/C             1
    S.C./A.4.       1
    S.O.P.          1
    A4.             1
    W.E.P.          1
    SO/C            1
    S.P.            1
    C.A./SOTON      1
    Name: ticket_number_alphabet, dtype: int64



- There are 42 distinct kinds of prefixes in the ticket number, and almost ticket numbers don't have a prefix alphabet. But it is hard to interpret the ticket number alphabet or to find some relationship with other columns.   
    -> Do not use ticket_number_alphabet

**ticket_number_number ~ p_class | is_survived**

Let's check if there is a relationship between ticket_number_number and p_class


```python
plt.figure(figsize = (14, 8))
sns.boxplot(data = pd.concat([titanic.p_class, titanic[titanic.ticket_number_number != "LINE"].ticket_number_number.astype("int32")], axis = 1), x = "p_class", y = "ticket_number_number")
plt.xlabel("Passenger class", fontsize = 14)
plt.ylabel("Ticket number part", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_59_0.png)
    


- It is hard to find relationship between ticket_number_number and p_class.        

Let's check if there is a relationship between ticket_number_number and is_survived


```python
plt.figure(figsize = (14, 8))
sns.boxplot(data = pd.concat([titanic.is_survived, titanic[titanic.ticket_number_number != "LINE"].ticket_number_number.astype("int32")], axis = 1), x = "is_survived", y = "ticket_number_number")
plt.xlabel("Is survived", fontsize = 14)
plt.ylabel("Ticket number part", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_62_0.png)
    


- It is hard to find relationship between ticket_number_number and p_class.        
    -> Do not use the ticket_number_number

**ticket_fare**


```python
np.sum(titanic["ticket_fare"].isnull())
```




    0



- There is no missing value in the ticket_fare column


```python
titanic["ticket_fare"].describe()
```




    count    891.000000
    mean      32.204208
    std       49.693429
    min        0.000000
    25%        7.910400
    50%       14.454200
    75%       31.000000
    max      512.329200
    Name: ticket_fare, dtype: float64




```python
plt.figure(figsize = (14, 8))

sns.histplot(titanic.ticket_fare)
plt.xlabel("Ticket fare", fontsize = 14)
plt.ylabel("Count", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_68_0.png)
    


- Minimum value is 0 and maximum value is 512.33.
- 75% of ticket fares are under 31.
- These numerical values and the histogram show that the standard deviation is very large.      
    -> Let's check the histogram of ticket fares under the 95% percentile.


```python
ticket_fares_95 = np.percentile(titanic["ticket_fare"], 95)
ticket_fares_95
```




    112.07915




```python
fig, (ax_box, ax_hist) = plt.subplots(2, sharex = True, gridspec_kw = {"height_ratios": (.2, .8)}, figsize = (10, 7))

sns.boxplot(x = titanic.ticket_fare, ax = ax_box, showfliers = False)
sns.histplot(x = titanic[titanic["ticket_fare"] <= ticket_fares_95].ticket_fare, ax = ax_hist)

plt.xlabel("Ticket Fare", fontsize = 16)
plt.ylabel("Count", fontsize = 16)
ax_box.set_xlabel("")

plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_71_0.png)
    


- 50% of ticket fares are under 14 and almost ticket fares are under 30.

Now, let's check outliers


```python
titanic[titanic["ticket_fare"] == 0]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>179</th>
      <td>0</td>
      <td>3</td>
      <td>Leonard, Mr. Lionel</td>
      <td>male</td>
      <td>36.0</td>
      <td>0</td>
      <td>0</td>
      <td>LINE</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>LINE</td>
      <td>3</td>
    </tr>
    <tr>
      <th>263</th>
      <td>0</td>
      <td>1</td>
      <td>Harrison, Mr. William</td>
      <td>male</td>
      <td>40.0</td>
      <td>0</td>
      <td>0</td>
      <td>112059</td>
      <td>0.0</td>
      <td>B94</td>
      <td>S</td>
      <td>non</td>
      <td>112059</td>
      <td>0</td>
    </tr>
    <tr>
      <th>271</th>
      <td>1</td>
      <td>3</td>
      <td>Tornquist, Mr. William Henry</td>
      <td>male</td>
      <td>25.0</td>
      <td>0</td>
      <td>0</td>
      <td>LINE</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>LINE</td>
      <td>3</td>
    </tr>
    <tr>
      <th>277</th>
      <td>0</td>
      <td>2</td>
      <td>Parkes, Mr. Francis "Frank"</td>
      <td>male</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>239853</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>239853</td>
      <td>2</td>
    </tr>
    <tr>
      <th>302</th>
      <td>0</td>
      <td>3</td>
      <td>Johnson, Mr. William Cahoone Jr</td>
      <td>male</td>
      <td>19.0</td>
      <td>0</td>
      <td>0</td>
      <td>LINE</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>LINE</td>
      <td>3</td>
    </tr>
    <tr>
      <th>413</th>
      <td>0</td>
      <td>2</td>
      <td>Cunningham, Mr. Alfred Fleming</td>
      <td>male</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>239853</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>239853</td>
      <td>2</td>
    </tr>
    <tr>
      <th>466</th>
      <td>0</td>
      <td>2</td>
      <td>Campbell, Mr. William</td>
      <td>male</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>239853</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>239853</td>
      <td>2</td>
    </tr>
    <tr>
      <th>481</th>
      <td>0</td>
      <td>2</td>
      <td>Frost, Mr. Anthony Wood "Archie"</td>
      <td>male</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>239854</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>239854</td>
      <td>0</td>
    </tr>
    <tr>
      <th>597</th>
      <td>0</td>
      <td>3</td>
      <td>Johnson, Mr. Alfred</td>
      <td>male</td>
      <td>49.0</td>
      <td>0</td>
      <td>0</td>
      <td>LINE</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>LINE</td>
      <td>3</td>
    </tr>
    <tr>
      <th>633</th>
      <td>0</td>
      <td>1</td>
      <td>Parr, Mr. William Henry Marsh</td>
      <td>male</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>112052</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>112052</td>
      <td>0</td>
    </tr>
    <tr>
      <th>674</th>
      <td>0</td>
      <td>2</td>
      <td>Watson, Mr. Ennis Hastings</td>
      <td>male</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>239856</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>239856</td>
      <td>0</td>
    </tr>
    <tr>
      <th>732</th>
      <td>0</td>
      <td>2</td>
      <td>Knight, Mr. Robert J</td>
      <td>male</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>239855</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>239855</td>
      <td>0</td>
    </tr>
    <tr>
      <th>806</th>
      <td>0</td>
      <td>1</td>
      <td>Andrews, Mr. Thomas Jr</td>
      <td>male</td>
      <td>39.0</td>
      <td>0</td>
      <td>0</td>
      <td>112050</td>
      <td>0.0</td>
      <td>A36</td>
      <td>S</td>
      <td>non</td>
      <td>112050</td>
      <td>0</td>
    </tr>
    <tr>
      <th>815</th>
      <td>0</td>
      <td>1</td>
      <td>Fry, Mr. Richard</td>
      <td>male</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>112058</td>
      <td>0.0</td>
      <td>B102</td>
      <td>S</td>
      <td>non</td>
      <td>112058</td>
      <td>0</td>
    </tr>
    <tr>
      <th>822</th>
      <td>0</td>
      <td>1</td>
      <td>Reuchlin, Jonkheer. John George</td>
      <td>male</td>
      <td>38.0</td>
      <td>0</td>
      <td>0</td>
      <td>19972</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>19972</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>



- There are only 15 rows whose ticket fare is 0.0. So 0 may mean a missing value.    
    -> In the above ticket_number EDA, we have found that the same ticket numbers have the same ticket fares. So let's check if other rows have non-zero fare with the same ticket numbers as the above table.


```python
for tn in titanic[titanic["ticket_fare"] == 0].ticket_number.unique():
    print(tn, " :", titanic[(titanic["ticket_fare"] != 0) & (titanic.ticket_number == tn)].shape)
```

    LINE  : (0, 14)
    112059  : (0, 14)
    239853  : (0, 14)
    239854  : (0, 14)
    112052  : (0, 14)
    239856  : (0, 14)
    239855  : (0, 14)
    112050  : (0, 14)
    112058  : (0, 14)
    19972  : (0, 14)


- All row whose fare is 0 doesn't have other rows that have the same ticket number as the non-zero fare. So it isn't possible to impute the ticket fare values with ticket number information.       
    -> Since there are no missing values in p_class, let's use p_class to impute the missing value in the ticket_fare column.

**ticket_fare ~ p_class**

Let's check relationship between ticket_fare and p_class


```python
titanic.groupby("p_class").ticket_fare.median().reset_index().rename({"ticket_fare" : "ticket_fare_median"}, axis = 1) \
    .merge(titanic.groupby("p_class").ticket_fare.mean().reset_index().rename({"ticket_fare" : "ticket_fare_mean"}, axis = 1), on = "p_class", how = "left")
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>ticket_fare_median</th>
      <th>ticket_fare_mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>60.2875</td>
      <td>84.154687</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>14.2500</td>
      <td>20.662183</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>8.0500</td>
      <td>13.675550</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))

sns.boxplot(data = titanic, x = "p_class", y = "ticket_fare")
plt.xlabel("Passenger class", fontsize = 14)
plt.ylabel("Ticket fare", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_81_0.png)
    


- We can see that there are meaningful differences in mean and median values of ticket fares between passenger classes.     
    -> Since there were no missing values in passenger class, I think it is a good way to impute missing value in ticket fare with the mean or median value of each passenger class. In the above box plot, we can see that there are some extreme values in passenger class = 1. Since mean is affected a lot with extreme values, let's use median instead of mean to impute ticket fare.


```python
p_class_fare_median = titanic.groupby("p_class").ticket_fare.median().reset_index().rename({"ticket_fare" : "ticket_fare_median"}, axis = 1)
p_class_fare_median
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>ticket_fare_median</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>60.2875</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>14.2500</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>8.0500</td>
    </tr>
  </tbody>
</table>
</div>




```python
titanic.loc[(titanic.ticket_fare == 0) & (titanic.p_class == 1), "ticket_fare"] = p_class_fare_median[p_class_fare_median.p_class == 1].ticket_fare_median.values[0]
titanic.loc[(titanic.ticket_fare == 0) & (titanic.p_class == 2), "ticket_fare"] = p_class_fare_median[p_class_fare_median.p_class == 2].ticket_fare_median.values[0]
titanic.loc[(titanic.ticket_fare == 0) & (titanic.p_class == 3), "ticket_fare"] = p_class_fare_median[p_class_fare_median.p_class == 3].ticket_fare_median.values[0]
```


```python
titanic.shape
```




    (891, 14)




```python
titanic[titanic.ticket_fare == 0]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>




```python
titanic[titanic.ticket_fare.isnull()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>



**ticket_fare ~ is_survived**


```python
plt.figure(figsize = (14, 8))

sns.boxplot(data = titanic, x = "is_survived", y = "ticket_fare", showfliers = False)
plt.xlabel("Is survived", fontsize = 14)
plt.ylabel("Ticket fare", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_89_0.png)
    


- It seems that passengers who paid the higher fare may have been more likely to have survived.         
    -> Let's cut the ticket_fare into 3 categories and compare the survival rate of each category. 


```python
titanic['ticket_fare_category'] = pd.qcut(titanic.ticket_fare, 3)
titanic.ticket_fare_category.value_counts()
```




    (8.676, 26.25]                300
    (4.010999999999999, 8.676]    297
    (26.25, 512.329]              294
    Name: ticket_fare_category, dtype: int64




```python
ticket_fare_category_is_survived = pd.pivot_table(index = "ticket_fare_category", columns = "is_survived", aggfunc = len, fill_value = 0, data = titanic[["ticket_fare_category", "is_survived"]])
ticket_fare_category_is_survived = ticket_fare_category_is_survived.reset_index().rename_axis(None, axis = 1)
ticket_fare_category_is_survived["total"] = ticket_fare_category_is_survived[0] + ticket_fare_category_is_survived[1]
ticket_fare_category_is_survived["ratio"] = np.round(ticket_fare_category_is_survived[1] / ticket_fare_category_is_survived.total, 2)
ticket_fare_category_is_survived
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticket_fare_category</th>
      <th>0</th>
      <th>1</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>(4.010999999999999, 8.676]</td>
      <td>236</td>
      <td>61</td>
      <td>297</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>1</th>
      <td>(8.676, 26.25]</td>
      <td>180</td>
      <td>120</td>
      <td>300</td>
      <td>0.40</td>
    </tr>
    <tr>
      <th>2</th>
      <td>(26.25, 512.329]</td>
      <td>133</td>
      <td>161</td>
      <td>294</td>
      <td>0.55</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))

# bar graph for total students
color = "darkblue"
ax1 = sns.barplot(x = "ticket_fare_category", y = "total", color = color, alpha = 0.8, \
                  data = ticket_fare_category_is_survived)
top_bar = mpatches.Patch(color = color, label = 'Num of total passengers')

# bar graph for students have research experience
color = "lightblue"
ax2 = sns.barplot(x = "ticket_fare_category", y = 1,  color = color, alpha = 0.8, \
                  data = ticket_fare_category_is_survived)
ax2.set_xlabel("Ticket fare category", fontsize = 16)
ax2.set_ylabel("Number of passengers", fontsize = 16)
low_bar = mpatches.Patch(color = color, label = 'Num of survived passengers')

# ratio
plt.text(s = "20%", x = -0.05, y = 35, fontsize = 16)
plt.text(s = "41%", x = 0.95, y = 95, fontsize = 16)
plt.text(s = "56%", x = 1.95, y = 136, fontsize = 16)

plt.legend(handles=[top_bar, low_bar])
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_93_0.png)
    


- It can be seen that the category that paid a higher fare showed a higher survival rate.      
    -> Use the ticket_fare_category column.

**cabin_number**


```python
titanic["cabin_number"]
```




    0       NaN
    1       C85
    2       NaN
    3      C123
    4       NaN
           ... 
    886     NaN
    887     B42
    888     NaN
    889    C148
    890     NaN
    Name: cabin_number, Length: 891, dtype: object



- cabin_number is form of alphabet + number     
    -> Let's divide the alphabet part and make this alphabet as a new column


```python
titanic["cabin_alphabet"] = titanic.cabin_number.str[0]
titanic["cabin_alphabet"] = titanic["cabin_alphabet"].fillna("n")
```


```python
titanic.cabin_alphabet.value_counts()
```




    n    687
    C     59
    B     47
    D     33
    E     32
    A     15
    F     13
    G      4
    T      1
    Name: cabin_alphabet, dtype: int64



- n means missing values. There are too many missing values in the cabin_alphabet column      
    -> If it is not related with is_survived or p_class, then do not use cabin_number and cabin_alphabet

**cabin_alphabet ~ is_survived | p_class**

Let's check relationship between cabin_alphabet and p_class


```python
pt = pd.pivot_table(index = "p_class", columns = "cabin_alphabet", aggfunc = len, fill_value = 0, data = titanic[["p_class", "cabin_alphabet"]])
pt
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>cabin_alphabet</th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
      <th>F</th>
      <th>G</th>
      <th>T</th>
      <th>n</th>
    </tr>
    <tr>
      <th>p_class</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>15</td>
      <td>47</td>
      <td>59</td>
      <td>29</td>
      <td>25</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>40</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>4</td>
      <td>8</td>
      <td>0</td>
      <td>0</td>
      <td>168</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>5</td>
      <td>4</td>
      <td>0</td>
      <td>479</td>
    </tr>
  </tbody>
</table>
</div>



- There are too many missing values in passenger class = 2 and passenger class = 3

Let's check relationship between cabin_alphabet and is_survived.


```python
pt = pd.pivot_table(index = "is_survived", columns = "cabin_alphabet", aggfunc = len, fill_value = 0, data = titanic[["is_survived", "cabin_alphabet"]])
pt
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>cabin_alphabet</th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
      <th>F</th>
      <th>G</th>
      <th>T</th>
      <th>n</th>
    </tr>
    <tr>
      <th>is_survived</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8</td>
      <td>12</td>
      <td>24</td>
      <td>8</td>
      <td>8</td>
      <td>5</td>
      <td>2</td>
      <td>1</td>
      <td>481</td>
    </tr>
    <tr>
      <th>1</th>
      <td>7</td>
      <td>35</td>
      <td>35</td>
      <td>25</td>
      <td>24</td>
      <td>8</td>
      <td>2</td>
      <td>0</td>
      <td>206</td>
    </tr>
  </tbody>
</table>
</div>



- Also, there are too many missing values in both is_survived cases     
    -> Do not use cabin_number and cabin_alphabet

**embark_port**


```python
titanic.embark_port.value_counts().reset_index().rename(columns = {"index" : "embark_port", "embark_port" : "count"})
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>embark_port</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>S</td>
      <td>644</td>
    </tr>
    <tr>
      <th>1</th>
      <td>C</td>
      <td>168</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Q</td>
      <td>77</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))
sns.barplot(data = titanic.embark_port.value_counts().reset_index().rename(columns = {"index" : "embark_port", "embark_port" : "count"}),
            x = "embark_port",
            y = "count")
plt.xlabel("Embark port", fontsize = 14)
plt.ylabel("Count", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_110_0.png)
    


- Most passengers boarded from Southampton (S) port
- Least passengers boarded from Queenstown (Q) port     


```python
titanic[titanic.embark_port.isnull()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
      <th>ticket_fare_category</th>
      <th>cabin_alphabet</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>61</th>
      <td>1</td>
      <td>1</td>
      <td>Icard, Miss. Amelie</td>
      <td>female</td>
      <td>38.0</td>
      <td>0</td>
      <td>0</td>
      <td>113572</td>
      <td>80.0</td>
      <td>B28</td>
      <td>NaN</td>
      <td>non</td>
      <td>113572</td>
      <td>1</td>
      <td>(26.25, 512.329]</td>
      <td>B</td>
    </tr>
    <tr>
      <th>829</th>
      <td>1</td>
      <td>1</td>
      <td>Stone, Mrs. George Nelson (Martha Evelyn)</td>
      <td>female</td>
      <td>62.0</td>
      <td>0</td>
      <td>0</td>
      <td>113572</td>
      <td>80.0</td>
      <td>B28</td>
      <td>NaN</td>
      <td>non</td>
      <td>113572</td>
      <td>1</td>
      <td>(26.25, 512.329]</td>
      <td>B</td>
    </tr>
  </tbody>
</table>
</div>



- There are only 2 rows where embark_port has a missing value.       
    -> Fill missing value with the most common embarked_pork value: S


```python
titanic["embark_port"] = titanic["embark_port"].fillna("S")
```


```python
np.sum(titanic.embark_port.isnull())
```




    0



**embark_port ~ p_class**

Let's check a relationship between embark_port and p_class


```python
pd.pivot_table(index = "p_class", columns = "embark_port", aggfunc = len, fill_value = 0, data = titanic[titanic.ticket_fare != 0][["p_class", "embark_port"]])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>embark_port</th>
      <th>C</th>
      <th>Q</th>
      <th>S</th>
    </tr>
    <tr>
      <th>p_class</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>85</td>
      <td>2</td>
      <td>129</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17</td>
      <td>3</td>
      <td>164</td>
    </tr>
    <tr>
      <th>3</th>
      <td>66</td>
      <td>72</td>
      <td>353</td>
    </tr>
  </tbody>
</table>
</div>



- Almost every people who boarded from Q was 3 passenger class.            
    -> Since embark_port has some influence in passenger class, let's check the relationship between embark_port and is_survived

**embark_port ~ is_survived**


```python
embark_port_is_survived = titanic.groupby(["embark_port","is_survived"]).count().name.unstack().reset_index()
embark_port_is_survived = embark_port_is_survived.rename_axis(None, axis = 1)
embark_port_is_survived["total"] = embark_port_is_survived[0] + embark_port_is_survived[1]
embark_port_is_survived["ratio"] = np.round(embark_port_is_survived[1] / embark_port_is_survived.total, 2)
embark_port_is_survived
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>embark_port</th>
      <th>0</th>
      <th>1</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>C</td>
      <td>75</td>
      <td>93</td>
      <td>168</td>
      <td>0.55</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Q</td>
      <td>47</td>
      <td>30</td>
      <td>77</td>
      <td>0.39</td>
    </tr>
    <tr>
      <th>2</th>
      <td>S</td>
      <td>427</td>
      <td>219</td>
      <td>646</td>
      <td>0.34</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))

# bar graph for total students
color = "darkblue"
ax1 = sns.barplot(x = "embark_port", y = "total", color = color, alpha = 0.8, \
                  data = embark_port_is_survived)
top_bar = mpatches.Patch(color = color, label = 'Num of total passengers')

# bar graph for students have research experience
color = "lightblue"
ax2 = sns.barplot(x = "embark_port", y = 1,  color = color, alpha = 0.8, \
                  data = embark_port_is_survived)
ax2.set_xlabel("Port of Embarkation", fontsize = 16)
ax2.set_ylabel("Number of passengers", fontsize = 16)
low_bar = mpatches.Patch(color = color, label = 'Num of survived passengers')

# ratio
plt.text(s = "55%", x = -0.05, y = 68, fontsize = 16)
plt.text(s = "39%", x = 0.95, y = 5, fontsize = 16)
plt.text(s = "34%", x = 1.95, y = 194, fontsize = 16)

plt.legend(handles=[top_bar, low_bar])
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_122_0.png)
    


- People boarded from Q and S have similar survival rates: about 39% and 34%.      
- People boarded from C have a higher survival rate than people boarded from other ports.        
    -> Use embark_port column

## 1.1. Person related columns: name, sex, age

**name**


```python
np.sum(titanic.name.isnull())
```




    0



- There is no missing value in the name column.


```python
len(titanic.name.unique())
```




    891



- All 891 rows have differnt name values.      
    -> Let's think about more general features from name.


```python
titanic.name.head(10)
```




    0                              Braund, Mr. Owen Harris
    1    Cumings, Mrs. John Bradley (Florence Briggs Th...
    2                               Heikkinen, Miss. Laina
    3         Futrelle, Mrs. Jacques Heath (Lily May Peel)
    4                             Allen, Mr. William Henry
    5                                     Moran, Mr. James
    6                              McCarthy, Mr. Timothy J
    7                       Palsson, Master. Gosta Leonard
    8    Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)
    9                  Nasser, Mrs. Nicholas (Adele Achem)
    Name: name, dtype: object



- We can see that names are a form of Last name + title + first name.      
    -> Let's extract the title from the name


```python
titanic["name_title"] = titanic.name.str.extract(' ([A-Za-z]+)\.', expand=False)
titanic.name_title.value_counts()
```




    Mr          517
    Miss        182
    Mrs         125
    Master       40
    Dr            7
    Rev           6
    Mlle          2
    Major         2
    Col           2
    Countess      1
    Capt          1
    Ms            1
    Sir           1
    Lady          1
    Mme           1
    Don           1
    Jonkheer      1
    Name: name_title, dtype: int64



- There are too many uncommon titles that appear only a few times.     
    -> Let's replace uncommon titles.


```python
titanic['name_title'] = titanic['name_title'].replace(['Lady', 'Countess','Capt', 'Col', 'Don', 'Dr', 'Major', \
                                                       'Rev', 'Sir', 'Jonkheer', 'Dona'], 'uncommon')

titanic['name_title'] = titanic['name_title'].replace('Mlle', 'Miss')
titanic['name_title'] = titanic['name_title'].replace('Ms', 'Miss')
titanic['name_title'] = titanic['name_title'].replace('Mme', 'Mrs')
```


```python
titanic.name_title.value_counts()
```




    Mr          517
    Miss        185
    Mrs         126
    Master       40
    uncommon     23
    Name: name_title, dtype: int64



**name_title ~ is_survived**

Let's check the relationship between name_title and is_survived.


```python
name_title_is_survived = titanic.groupby(["name_title","is_survived"]).count().name.unstack().reset_index()
name_title_is_survived = name_title_is_survived.rename_axis(None, axis = 1)
name_title_is_survived["total"] = name_title_is_survived[0] + name_title_is_survived[1]
name_title_is_survived["ratio"] = np.round(name_title_is_survived[1] / name_title_is_survived.total, 2)
name_title_is_survived
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name_title</th>
      <th>0</th>
      <th>1</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Master</td>
      <td>17</td>
      <td>23</td>
      <td>40</td>
      <td>0.57</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Miss</td>
      <td>55</td>
      <td>130</td>
      <td>185</td>
      <td>0.70</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Mr</td>
      <td>436</td>
      <td>81</td>
      <td>517</td>
      <td>0.16</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Mrs</td>
      <td>26</td>
      <td>100</td>
      <td>126</td>
      <td>0.79</td>
    </tr>
    <tr>
      <th>4</th>
      <td>uncommon</td>
      <td>15</td>
      <td>8</td>
      <td>23</td>
      <td>0.35</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))

# bar graph for total students
color = "darkblue"
ax1 = sns.barplot(x = "name_title", y = "total", color = color, alpha = 0.8, \
                  data = name_title_is_survived)
top_bar = mpatches.Patch(color = color, label = 'Num of total passengers')

# bar graph for students have research experience
color = "lightblue"
ax2 = sns.barplot(x = "name_title", y = 1,  color = color, alpha = 0.8, \
                  data = name_title_is_survived)
ax2.set_xlabel("Name title", fontsize = 16)
ax2.set_ylabel("Number of passengers", fontsize = 16)
low_bar = mpatches.Patch(color = color, label = 'Num of survived passengers')

# ratio
for n in name_title_is_survived.index:
    plt.text(s = f"{np.round(name_title_is_survived.loc[n].ratio * 100, 2)} %", x = n - 0.1, y = name_title_is_survived.loc[n][1] + 5, color = "white")
 
    
plt.legend(handles=[top_bar, low_bar])
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_139_0.png)
    


- Passengers with Miss and Mrs titles showed an overwhelming survival rate of over 70%     
    -> Use name_title instead of name

**sex**


```python
np.sum(titanic.sex.isnull())
```




    0



- There is no missing value in the sex column.


```python
titanic.sex.value_counts()
```




    male      577
    female    314
    Name: sex, dtype: int64




```python
plt.figure(figsize = (14, 8))
sns.barplot(data = titanic.sex.value_counts().reset_index().rename(columns = {"index" : "sex", "sex" : "count"}),
            x = "sex",
            y = "count")
plt.xlabel("Sex", fontsize = 14)
plt.ylabel("Count", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_145_0.png)
    


- There are about twice as many male passengers as female passengers.

**sex ~ p_class**

Let's check the relationship between sex and p_class.


```python
sex_p_class = pd.pivot_table(index = "p_class", columns = "sex", aggfunc = len, fill_value = 0, data = titanic[["p_class", "sex"]])
sex_p_class = sex_p_class.reset_index().rename_axis(None, axis = 1)
sex_p_class["total"] = sex_p_class["female"] + sex_p_class["male"]
sex_p_class["ratio"] = np.round(sex_p_class["male"] / sex_p_class.total, 2)
sex_p_class
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>female</th>
      <th>male</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>94</td>
      <td>122</td>
      <td>216</td>
      <td>0.56</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>76</td>
      <td>108</td>
      <td>184</td>
      <td>0.59</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>144</td>
      <td>347</td>
      <td>491</td>
      <td>0.71</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))

# bar graph for total students
color = "darkblue"
ax1 = sns.barplot(x = "p_class", y = "total", color = color, alpha = 0.8, \
                  data = sex_p_class)
top_bar = mpatches.Patch(color = color, label = 'Num of total passengers')

# bar graph for students have research experience
color = "lightblue"
ax2 = sns.barplot(x = "p_class", y = "male",  color = color, alpha = 0.8, \
                  data = sex_p_class)
ax2.set_xlabel("Passenger class", fontsize = 16)
ax2.set_ylabel("Number of passengers", fontsize = 16)
low_bar = mpatches.Patch(color = color, label = 'Num of male passengers')

# ratio
plt.text(s = "56%", x = -0.05, y = 97, fontsize = 16)
plt.text(s = "59%", x = 0.95, y = 83, fontsize = 16)
plt.text(s = "71%", x = 1.95, y = 322, fontsize = 16)

plt.legend(handles=[top_bar, low_bar])
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_150_0.png)
    


- Passengers from classes 1 and 2 have a similar male rate: about 56% and 59%    
- Passengers from class 3 have a higher male rate than passengers from other classes.

**sex ~ is_survived**


```python
sex_is_survived = pd.pivot_table(index = "sex", columns = "is_survived", aggfunc = len, fill_value = 0, data = titanic[["is_survived", "sex"]])
sex_is_survived = sex_is_survived.reset_index().rename_axis(None, axis = 1)
sex_is_survived["total"] = sex_is_survived[0] + sex_is_survived[1]
sex_is_survived["ratio"] = np.round(sex_is_survived[1] / sex_is_survived.total, 2)
sex_is_survived
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sex</th>
      <th>0</th>
      <th>1</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>female</td>
      <td>81</td>
      <td>233</td>
      <td>314</td>
      <td>0.74</td>
    </tr>
    <tr>
      <th>1</th>
      <td>male</td>
      <td>468</td>
      <td>109</td>
      <td>577</td>
      <td>0.19</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))

# bar graph for total students
color = "darkblue"
ax1 = sns.barplot(x = "sex", y = "total", color = color, alpha = 0.8, \
                  data = sex_is_survived)
top_bar = mpatches.Patch(color = color, label = 'Num of total passengers')

# bar graph for students have research experience
color = "lightblue"
ax2 = sns.barplot(x = "sex", y = 1,  color = color, alpha = 0.8, \
                  data = sex_is_survived)
ax2.set_xlabel("Sex", fontsize = 16)
ax2.set_ylabel("Number of passengers", fontsize = 16)
low_bar = mpatches.Patch(color = color, label = 'Num of survived passengers')

# ratio
plt.text(s = "74%", x = -0.05, y = 208, fontsize = 16)
plt.text(s = "19%", x = 0.95, y = 84, fontsize = 16)

plt.legend(handles=[top_bar, low_bar])
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_154_0.png)
    


- We can see that sex had a huge impact on survival. Only 19% of the male passengers survived, while 74% of the female passengers survived.     
    -> Use sex column

**age**


```python
np.sum(titanic.age.isnull())
```




    177



- There are 177 missing values in the age column      
    -> Need to think about how to impute missing values.


```python
titanic.age.describe()
```




    count    714.000000
    mean      29.699118
    std       14.526497
    min        0.420000
    25%       20.125000
    50%       28.000000
    75%       38.000000
    max       80.000000
    Name: age, dtype: float64




```python
fig, (ax_box, ax_hist) = plt.subplots(2, sharex = True, gridspec_kw = {"height_ratios": (.2, .8)}, figsize = (10, 7))

sns.boxplot(x = titanic.age, ax = ax_box, showfliers = False)
sns.histplot(x = titanic.age, ax = ax_hist)

plt.xlabel("Age", fontsize = 16)
plt.ylabel("Count", fontsize = 16)
ax_box.set_xlabel("")

plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_160_0.png)
    


- age shows a slightly bell-shaped distribution 

For further analysis, let's make new column of age category.


```python
import math
```


```python
math.log(0.04 * 0.05 * 0.06) * -2
```




    18.056037630364457




```python
math.log(0.6 * 0.25 * 0.01) * -2
```




    13.004580341747944




```python
titanic["age_category"] = pd.cut(titanic.age, 10)
titanic.age_category.value_counts()
```




    (16.336, 24.294]    177
    (24.294, 32.252]    169
    (32.252, 40.21]     118
    (40.21, 48.168]      70
    (0.34, 8.378]        54
    (8.378, 16.336]      46
    (48.168, 56.126]     45
    (56.126, 64.084]     24
    (64.084, 72.042]      9
    (72.042, 80.0]        2
    Name: age_category, dtype: int64



**p_class ~ age | age_category**

Let's check the relationship between p_class and age.


```python
plt.figure(figsize = (14, 8))

sns.boxplot(data = titanic, x = "p_class", y = "age")
plt.xlabel("Passenger class", fontsize = 14)
plt.ylabel("Age", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_169_0.png)
    


- The better the class, the older the passengers in it tend to be.

Let's see the relationship of passenger class and age by age category.


```python
pt = pd.pivot_table(index = "p_class", columns = "age_category", aggfunc = len, fill_value = 0, data = titanic[["p_class", "age_category"]])

plt.figure(figsize = (14, 8))
sns.heatmap(pt, annot = True, cmap = 'BrBG');
plt.xlabel("Age category", fontsize = 14)
plt.ylabel("Passenger class", fontsize = 14)
plt.show()

```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_172_0.png)
    


- In particular, in class 3, it can be seen that the proportion of young people is high.
- In classes 1 and 2, the proportion of passengers in the middle age group is high.     
    -> There seems to be some relationship between age and class. So, let's look at the relationship between age and survival rate.

**is_survived ~ age | age_category**

Let's check the relationship between is_survived and age.


```python
plt.figure(figsize = (14, 8))

sns.boxplot(data = titanic, x = "is_survived", y = "age")
plt.xlabel("Is survived", fontsize = 14)
plt.ylabel("Age", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_176_0.png)
    


- There appears to be no difference in the distribution of age between the survived and non-survived groups.


```python
age_category_is_survived = pd.pivot_table(index = "age_category", columns = "is_survived", aggfunc = len, fill_value = 0, data = titanic[["is_survived", "age_category"]])
age_category_is_survived = age_category_is_survived.reset_index().rename_axis(None, axis = 1)
age_category_is_survived["total"] = age_category_is_survived[0] + age_category_is_survived[1]
age_category_is_survived["ratio"] = np.round(age_category_is_survived[1] / age_category_is_survived.total, 2)
age_category_is_survived
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age_category</th>
      <th>0</th>
      <th>1</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>(0.34, 8.378]</td>
      <td>18</td>
      <td>36</td>
      <td>54</td>
      <td>0.67</td>
    </tr>
    <tr>
      <th>1</th>
      <td>(8.378, 16.336]</td>
      <td>27</td>
      <td>19</td>
      <td>46</td>
      <td>0.41</td>
    </tr>
    <tr>
      <th>2</th>
      <td>(16.336, 24.294]</td>
      <td>114</td>
      <td>63</td>
      <td>177</td>
      <td>0.36</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(24.294, 32.252]</td>
      <td>104</td>
      <td>65</td>
      <td>169</td>
      <td>0.38</td>
    </tr>
    <tr>
      <th>4</th>
      <td>(32.252, 40.21]</td>
      <td>66</td>
      <td>52</td>
      <td>118</td>
      <td>0.44</td>
    </tr>
    <tr>
      <th>5</th>
      <td>(40.21, 48.168]</td>
      <td>46</td>
      <td>24</td>
      <td>70</td>
      <td>0.34</td>
    </tr>
    <tr>
      <th>6</th>
      <td>(48.168, 56.126]</td>
      <td>24</td>
      <td>21</td>
      <td>45</td>
      <td>0.47</td>
    </tr>
    <tr>
      <th>7</th>
      <td>(56.126, 64.084]</td>
      <td>15</td>
      <td>9</td>
      <td>24</td>
      <td>0.38</td>
    </tr>
    <tr>
      <th>8</th>
      <td>(64.084, 72.042]</td>
      <td>9</td>
      <td>0</td>
      <td>9</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>9</th>
      <td>(72.042, 80.0]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0.50</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))

# bar graph for total students
color = "darkblue"
ax1 = sns.barplot(x = "age_category", y = "total", color = color, alpha = 0.8, \
                  data = age_category_is_survived)
top_bar = mpatches.Patch(color = color, label = 'Num of total passengers')

# bar graph for students have research experience
color = "lightblue"
ax2 = sns.barplot(x = "age_category", y = 1,  color = color, alpha = 0.8, \
                  data = age_category_is_survived)
ax2.set_xlabel("Age category", fontsize = 16)
ax2.set_ylabel("Number of passengers", fontsize = 16)
low_bar = mpatches.Patch(color = color, label = 'Num of survived passengers')

# ratio
for n in age_category_is_survived.index:
    plt.text(s = f"{age_category_is_survived.loc[n].ratio * 100} %", x = n - 0.2, y = age_category_is_survived.loc[n][1] + 5, color = "lightblue")
 
    
plt.legend(handles=[top_bar, low_bar])
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_179_0.png)
    


- It can be seen that the survival rate decreases with increasing age and then rises again.                
    -> Use age category and age. Then since age has 177 missing values, we have to consider how to impute missing values in age.

**age ~ sex**

Let's check the relationship between age and sex.


```python
plt.figure(figsize = (14, 8))

sns.boxplot(data = titanic, x = "sex", y = "age")
plt.xlabel("Sex", fontsize = 14)
plt.ylabel("Age", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_183_0.png)
    


- There appears to be no difference in the distribution of age between the male and female groups.

Let's check the distribution in more detail using age category.


```python
age_sex = titanic.groupby(["age_category"]).sex.value_counts().unstack().fillna(0)
age_sex = age_sex.reset_index().rename_axis(None, axis = 1)
age_sex
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age_category</th>
      <th>female</th>
      <th>male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>(0.34, 8.378]</td>
      <td>26.0</td>
      <td>28.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>(8.378, 16.336]</td>
      <td>23.0</td>
      <td>23.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>(16.336, 24.294]</td>
      <td>68.0</td>
      <td>109.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(24.294, 32.252]</td>
      <td>52.0</td>
      <td>117.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>(32.252, 40.21]</td>
      <td>44.0</td>
      <td>74.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>(40.21, 48.168]</td>
      <td>24.0</td>
      <td>46.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>(48.168, 56.126]</td>
      <td>16.0</td>
      <td>29.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>(56.126, 64.084]</td>
      <td>8.0</td>
      <td>16.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>(64.084, 72.042]</td>
      <td>0.0</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>(72.042, 80.0]</td>
      <td>0.0</td>
      <td>2.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
#define plot parameters
fig, axes = plt.subplots(ncols=2, sharey=True, figsize=(20, 8))

#specify background color and plot title
#fig.patch.set_facecolor('xkcd:light grey')
plt.figtext(.5,.9,"Population Pyramid ", fontsize=16, ha='center')
    
#define male and female bars
axes[0].barh(range(0, len(age_sex)), age_sex.male, align='center', color='darkblue')
axes[0].set(title='Males')
axes[1].barh(range(0, len(age_sex)), age_sex.female, align='center', color='darkred')
axes[1].set(title='Females')

#adjust grid parameters and specify labels for y-axis
axes[1].grid()
axes[0].set(yticks = range(0, len(age_sex)), yticklabels = age_sex['age_category'])
axes[0].invert_xaxis()
axes[0].grid()

#display plot
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_187_0.png)
    


- It can be seen that there are typical demographic distributions, with very few passengers in the older and young group and a large number of passengers in the middle-aged group.     
    -> Let's check survival rate by sex and age_category.

**sex ~ age ~ is_survived**


```python
male_age_sex = pd.DataFrame(age_sex.age_category.unique(), columns = ["age_category"])

male_age_sex = male_age_sex.merge(pd.pivot_table(index = "age_category", columns = "is_survived", aggfunc = len, fill_value = 0, 
                                                 data = titanic[titanic.sex == "male"][["is_survived", "age_category"]]) \
                                  .reset_index().rename_axis(None, axis = 1),
                                  on = "age_category", how = "left")
male_age_sex["total"] = male_age_sex[0] + male_age_sex[1]
male_age_sex["ratio"] = np.round(male_age_sex[1] / male_age_sex.total, 2)
male_age_sex[[0, 1, "total", "ratio"]] = male_age_sex[[0, 1, "total", "ratio"]].fillna(0)
male_age_sex
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age_category</th>
      <th>0</th>
      <th>1</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>(0.34, 8.378]</td>
      <td>11</td>
      <td>17</td>
      <td>28</td>
      <td>0.61</td>
    </tr>
    <tr>
      <th>1</th>
      <td>(8.378, 16.336]</td>
      <td>18</td>
      <td>5</td>
      <td>23</td>
      <td>0.22</td>
    </tr>
    <tr>
      <th>2</th>
      <td>(16.336, 24.294]</td>
      <td>98</td>
      <td>11</td>
      <td>109</td>
      <td>0.10</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(24.294, 32.252]</td>
      <td>88</td>
      <td>29</td>
      <td>117</td>
      <td>0.25</td>
    </tr>
    <tr>
      <th>4</th>
      <td>(32.252, 40.21]</td>
      <td>61</td>
      <td>13</td>
      <td>74</td>
      <td>0.18</td>
    </tr>
    <tr>
      <th>5</th>
      <td>(40.21, 48.168]</td>
      <td>37</td>
      <td>9</td>
      <td>46</td>
      <td>0.20</td>
    </tr>
    <tr>
      <th>6</th>
      <td>(48.168, 56.126]</td>
      <td>23</td>
      <td>6</td>
      <td>29</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>7</th>
      <td>(56.126, 64.084]</td>
      <td>14</td>
      <td>2</td>
      <td>16</td>
      <td>0.12</td>
    </tr>
    <tr>
      <th>8</th>
      <td>(64.084, 72.042]</td>
      <td>9</td>
      <td>0</td>
      <td>9</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>9</th>
      <td>(72.042, 80.0]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0.50</td>
    </tr>
  </tbody>
</table>
</div>




```python
female_age_sex = pd.DataFrame(age_sex.age_category.unique(), columns = ["age_category"])

female_age_sex = female_age_sex.merge(pd.pivot_table(index = "age_category", columns = "is_survived", aggfunc = len, fill_value = 0, 
                                                     data = titanic[titanic.sex == "female"][["is_survived", "age_category"]]) \
                                      .reset_index().rename_axis(None, axis = 1),
                                      on = "age_category", how = "left")
female_age_sex["total"] = female_age_sex[0] + female_age_sex[1]
female_age_sex["ratio"] = np.round(female_age_sex[1] / female_age_sex.total, 2)
female_age_sex[[0, 1, "total", "ratio"]] = female_age_sex[[0, 1, "total", "ratio"]].fillna(0)
female_age_sex
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age_category</th>
      <th>0</th>
      <th>1</th>
      <th>total</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>(0.34, 8.378]</td>
      <td>7.0</td>
      <td>19.0</td>
      <td>26.0</td>
      <td>0.73</td>
    </tr>
    <tr>
      <th>1</th>
      <td>(8.378, 16.336]</td>
      <td>9.0</td>
      <td>14.0</td>
      <td>23.0</td>
      <td>0.61</td>
    </tr>
    <tr>
      <th>2</th>
      <td>(16.336, 24.294]</td>
      <td>16.0</td>
      <td>52.0</td>
      <td>68.0</td>
      <td>0.76</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(24.294, 32.252]</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>52.0</td>
      <td>0.69</td>
    </tr>
    <tr>
      <th>4</th>
      <td>(32.252, 40.21]</td>
      <td>5.0</td>
      <td>39.0</td>
      <td>44.0</td>
      <td>0.89</td>
    </tr>
    <tr>
      <th>5</th>
      <td>(40.21, 48.168]</td>
      <td>9.0</td>
      <td>15.0</td>
      <td>24.0</td>
      <td>0.62</td>
    </tr>
    <tr>
      <th>6</th>
      <td>(48.168, 56.126]</td>
      <td>1.0</td>
      <td>15.0</td>
      <td>16.0</td>
      <td>0.94</td>
    </tr>
    <tr>
      <th>7</th>
      <td>(56.126, 64.084]</td>
      <td>1.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>0.88</td>
    </tr>
    <tr>
      <th>8</th>
      <td>(64.084, 72.042]</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>9</th>
      <td>(72.042, 80.0]</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.00</td>
    </tr>
  </tbody>
</table>
</div>




```python
#define plot parameters
fig, axes = plt.subplots(ncols=2, sharey=True, figsize=(20, 8))

#specify background color and plot title
#fig.patch.set_facecolor('xkcd:light grey')
plt.figtext(.5,.9,"Population Pyramid ", fontsize=16, ha='center')
    
#define male and female bars
axes[0].barh(range(0, len(age_sex)), male_age_sex.total, align='center', color='darkblue')
axes[0].barh(range(0, len(age_sex)), male_age_sex[1], align='center', color='lightblue')
axes[0].set(title='Males')
top_bar = mpatches.Patch(color = "darkblue", label = 'Num of total passengers')
low_bar = mpatches.Patch(color = "lightblue", label = 'Num of survived passengers')
axes[0].legend(handles = [top_bar, low_bar])


axes[1].barh(range(0, len(age_sex)), female_age_sex.total, align='center', color='darkred')
axes[1].barh(range(0, len(age_sex)), female_age_sex[1], align='center', color='pink')
axes[1].set(title='Females')
top_bar = mpatches.Patch(color = "darkred", label = 'Num of total passengers')
low_bar = mpatches.Patch(color = "pink", label = 'Num of survived passengers')
axes[1].legend(handles = [top_bar, low_bar])

#adjust grid parameters and specify labels for y-axis
axes[1].grid()
axes[0].set(yticks = range(0, len(age_sex)), yticklabels = age_sex['age_category'])
axes[0].invert_xaxis()
axes[0].grid()

#display plot
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_192_0.png)
    


- In all age groups, it can be seen that the survival rate of women is overwhelmingly higher than that of men.
- Children under the age of 8 have a particularly high survival rate for both male and female.

**name_title ~ age**

Let's check the relationship between name_title and age.


```python
plt.figure(figsize = (14, 8))

sns.boxplot(data = titanic, x = "name_title", y = "age")
plt.xlabel("Name title", fontsize = 14)
plt.ylabel("Age", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_196_0.png)
    


- It can be seen that there is a meaningful difference in the age distribution of name titles.         


```python
titanic[titanic.name_title == "Master"][["p_class", "name_title", "sex", "age", "age_category", "num_sb_sp", "num_pr_ch", "num_cmp"]].sort_values("age")
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name_title</th>
      <th>sex</th>
      <th>age</th>
      <th>age_category</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>803</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>0.42</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>755</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>0.67</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>831</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>0.83</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>78</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>0.83</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>305</th>
      <td>1</td>
      <td>Master</td>
      <td>male</td>
      <td>0.92</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>827</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>1.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>164</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>1.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>788</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>1.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>183</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>1.00</td>
      <td>(0.34, 8.378]</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>386</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>1.00</td>
      <td>(0.34, 8.378]</td>
      <td>5</td>
      <td>2</td>
      <td>7</td>
    </tr>
    <tr>
      <th>7</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>3</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>16</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>824</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>340</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>407</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>3.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>348</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>3.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>261</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>3.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>193</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>3.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>63</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>3</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>445</th>
      <td>1</td>
      <td>Master</td>
      <td>male</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>171</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>850</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>869</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>751</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>6.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>278</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>7.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>50</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>7.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>549</th>
      <td>2</td>
      <td>Master</td>
      <td>male</td>
      <td>8.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>787</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>8.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>480</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>9.00</td>
      <td>(8.378, 16.336]</td>
      <td>5</td>
      <td>2</td>
      <td>7</td>
    </tr>
    <tr>
      <th>489</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>9.00</td>
      <td>(8.378, 16.336]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>165</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>9.00</td>
      <td>(8.378, 16.336]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>182</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>9.00</td>
      <td>(8.378, 16.336]</td>
      <td>4</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>819</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>10.00</td>
      <td>(8.378, 16.336]</td>
      <td>3</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>802</th>
      <td>1</td>
      <td>Master</td>
      <td>male</td>
      <td>11.00</td>
      <td>(8.378, 16.336]</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>59</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>11.00</td>
      <td>(8.378, 16.336]</td>
      <td>5</td>
      <td>2</td>
      <td>7</td>
    </tr>
    <tr>
      <th>125</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>12.00</td>
      <td>(8.378, 16.336]</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>65</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>159</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8</td>
      <td>2</td>
      <td>10</td>
    </tr>
    <tr>
      <th>176</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>709</th>
      <td>3</td>
      <td>Master</td>
      <td>male</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>



- Passengers who have "Master" as their name_title are all under 12 ages.         
    -> Fill missing values with name_title "Master" with a mean age of passengers with "Master" name title


```python
titanic.loc[(titanic.name_title == "Master") & (titanic.age.isnull()), "age"] = np.mean(titanic[titanic.name_title == "Master"].age)
```


```python
titanic[(titanic.name_title == "Master") & (titanic.age.isnull())]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
      <th>ticket_fare_category</th>
      <th>cabin_alphabet</th>
      <th>name_title</th>
      <th>age_category</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>




```python
titanic[(titanic.age < 15) & (titanic.sex == "female")][["p_class", "name_title", "sex", "age", "age_category", "num_sb_sp", "num_pr_ch", "num_cmp"]].sort_values("age")
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name_title</th>
      <th>sex</th>
      <th>age</th>
      <th>age_category</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>644</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>0.75</td>
      <td>(0.34, 8.378]</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>469</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>0.75</td>
      <td>(0.34, 8.378]</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>172</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>1.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>381</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>1.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>479</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>642</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>3</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>297</th>
      <td>1</td>
      <td>Miss</td>
      <td>female</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>530</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>205</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>119</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>2.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>374</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>3.00</td>
      <td>(0.34, 8.378]</td>
      <td>3</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>43</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>3.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>184</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>750</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>691</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>618</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>4.00</td>
      <td>(0.34, 8.378]</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>233</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>5.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>58</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>5.00</td>
      <td>(0.34, 8.378]</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>777</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>5.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>448</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>5.00</td>
      <td>(0.34, 8.378]</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>720</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>6.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>813</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>6.00</td>
      <td>(0.34, 8.378]</td>
      <td>4</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>535</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>7.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>237</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>8.00</td>
      <td>(0.34, 8.378]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>24</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>8.00</td>
      <td>(0.34, 8.378]</td>
      <td>3</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>541</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>9.00</td>
      <td>(8.378, 16.336]</td>
      <td>4</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>147</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>9.00</td>
      <td>(8.378, 16.336]</td>
      <td>2</td>
      <td>2</td>
      <td>4</td>
    </tr>
    <tr>
      <th>634</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>9.00</td>
      <td>(8.378, 16.336]</td>
      <td>3</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>852</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>9.00</td>
      <td>(8.378, 16.336]</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>419</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>10.00</td>
      <td>(8.378, 16.336]</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>542</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>11.00</td>
      <td>(8.378, 16.336]</td>
      <td>4</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>780</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>13.00</td>
      <td>(8.378, 16.336]</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>446</th>
      <td>2</td>
      <td>Miss</td>
      <td>female</td>
      <td>13.00</td>
      <td>(8.378, 16.336]</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2</td>
      <td>Mrs</td>
      <td>female</td>
      <td>14.00</td>
      <td>(8.378, 16.336]</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>39</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>14.00</td>
      <td>(8.378, 16.336]</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>14</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>14.00</td>
      <td>(8.378, 16.336]</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>435</th>
      <td>1</td>
      <td>Miss</td>
      <td>female</td>
      <td>14.00</td>
      <td>(8.378, 16.336]</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>111</th>
      <td>3</td>
      <td>Miss</td>
      <td>female</td>
      <td>14.50</td>
      <td>(8.378, 16.336]</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>



- Almost every female passenger under 15 has the name title "Miss". But the age range of passengers with "Miss" is too broad.       
    -> let's consider linear regression to impute other missing values in age.

First, we have to convert customized categorical variables (ticket_fare_category) to numerical variables.


```python
# Make orderic variables for ticket_fare_category column

titanic.loc[titanic['ticket_fare'] <= 8.676, 'ticket_fare_category_order'] = 1
titanic.loc[(titanic['ticket_fare'] > 8.676) & (titanic['ticket_fare'] <= 26.25), 'ticket_fare_category_order'] = 2
titanic.loc[titanic['ticket_fare'] > 26.25, 'ticket_fare_category_order'] = 3
```


```python
titanic.ticket_fare_category.value_counts()
```




    (8.676, 26.25]                300
    (4.010999999999999, 8.676]    297
    (26.25, 512.329]              294
    Name: ticket_fare_category, dtype: int64




```python
titanic.ticket_fare_category_order.value_counts()
```




    2.0    300
    1.0    297
    3.0    294
    Name: ticket_fare_category_order, dtype: int64




```python
X = titanic[titanic.age.isnull() == False][["p_class", "num_sb_sp", "num_pr_ch", "ticket_fare", "num_cmp", "ticket_fare_category_order", "sex", "embark_port", "name_title"]]
y = titanic[titanic.age.isnull() == False].age
```


```python
num_features = ["p_class", "num_sb_sp", "num_pr_ch", "ticket_fare", "num_cmp", "ticket_fare_category_order"]
nonnum_features = ["sex", "embark_port", "name_title"]
```


```python
full_pipeline = ColumnTransformer([
    ("num", StandardScaler(), num_features),
    ("nonnum", OneHotEncoder(), nonnum_features),
])
```


```python
X_prep = full_pipeline.fit_transform(X)
X_prep
```




    array([[ 0.9065961 ,  0.48553535, -0.51099538, ...,  1.        ,
             0.        ,  0.        ],
           [-1.48215986,  0.48553535, -0.51099538, ...,  0.        ,
             1.        ,  0.        ],
           [ 0.9065961 , -0.54282565, -0.51099538, ...,  0.        ,
             0.        ,  0.        ],
           ...,
           [-1.48215986, -0.54282565, -0.51099538, ...,  0.        ,
             0.        ,  0.        ],
           [-1.48215986, -0.54282565, -0.51099538, ...,  1.        ,
             0.        ,  0.        ],
           [ 0.9065961 , -0.54282565, -0.51099538, ...,  1.        ,
             0.        ,  0.        ]])




```python
X_train, X_test, y_train, y_test = train_test_split(X_prep, y, test_size = 0.1, random_state = 42)
```


```python
X_train.shape, X_test.shape, y_train.shape, y_test.shape
```




    ((646, 16), (72, 16), (646,), (72,))




```python
lm = LinearRegression()
lm.fit(X_train, y_train)
```




    LinearRegression()




```python
result = cross_validate(lm, X_train, y_train, scoring = "neg_root_mean_squared_error", cv = 5)
```


```python
-np.mean(result["test_score"]), np.std(result["test_score"])
```




    (11.290133827852916, 0.5883957467368258)



- RMSE in the test set is 11. Since the age has values between 0 and 80, and RMSE gives us an idea of the average distance between the observed data values and the predicted data values, RMSE 11 shows our model is pretty good.      
    -> Then let's compare the result with predicting age with the median value of each name_title.


```python
test_prediction = lm.predict(X_test)

test_mse = mean_squared_error(y_test, test_prediction)
test_rmse = np.sqrt(test_mse)
```


```python
test_rmse
```




    11.065128385616424




```python
y_test.reset_index()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>148</td>
      <td>36.5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>406</td>
      <td>51.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>53</td>
      <td>29.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>796</td>
      <td>49.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>646</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>67</th>
      <td>352</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>68</th>
      <td>743</td>
      <td>24.0</td>
    </tr>
    <tr>
      <th>69</th>
      <td>829</td>
      <td>62.0</td>
    </tr>
    <tr>
      <th>70</th>
      <td>536</td>
      <td>45.0</td>
    </tr>
    <tr>
      <th>71</th>
      <td>827</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>72 rows × 2 columns</p>
</div>




```python
pd.DataFrame(test_prediction.reshape(-1))
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>33.711484</td>
    </tr>
    <tr>
      <th>1</th>
      <td>28.799848</td>
    </tr>
    <tr>
      <th>2</th>
      <td>35.226230</td>
    </tr>
    <tr>
      <th>3</th>
      <td>42.334043</td>
    </tr>
    <tr>
      <th>4</th>
      <td>28.799088</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>67</th>
      <td>25.547320</td>
    </tr>
    <tr>
      <th>68</th>
      <td>27.214570</td>
    </tr>
    <tr>
      <th>69</th>
      <td>42.273286</td>
    </tr>
    <tr>
      <th>70</th>
      <td>49.972924</td>
    </tr>
    <tr>
      <th>71</th>
      <td>10.913917</td>
    </tr>
  </tbody>
</table>
<p>72 rows × 1 columns</p>
</div>




```python
predict_result = pd.concat([y_test.reset_index(), pd.DataFrame(test_prediction.reshape(-1))], axis = 1) \
                 .rename({0 : "predict_by_lm"}, axis = 1)
```


```python
predict_result["name_title"] = titanic.loc[predict_result["index"]].name_title.values
```


```python
predict_result = predict_result.merge(titanic.groupby("name_title").age.median().reset_index().rename(columns = {"age" : "predict_by_medain_name_title"}), 
                                      on = "name_title", how = "left")
predict_result
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>age</th>
      <th>predict_by_lm</th>
      <th>name_title</th>
      <th>predict_by_medain_name_title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>148</td>
      <td>36.5</td>
      <td>33.711484</td>
      <td>Mr</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>406</td>
      <td>51.0</td>
      <td>28.799848</td>
      <td>Mr</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>53</td>
      <td>29.0</td>
      <td>35.226230</td>
      <td>Mrs</td>
      <td>35.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>796</td>
      <td>49.0</td>
      <td>42.334043</td>
      <td>uncommon</td>
      <td>48.5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>646</td>
      <td>19.0</td>
      <td>28.799088</td>
      <td>Mr</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>67</th>
      <td>352</td>
      <td>15.0</td>
      <td>25.547320</td>
      <td>Mr</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>68</th>
      <td>743</td>
      <td>24.0</td>
      <td>27.214570</td>
      <td>Mr</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>69</th>
      <td>829</td>
      <td>62.0</td>
      <td>42.273286</td>
      <td>Mrs</td>
      <td>35.0</td>
    </tr>
    <tr>
      <th>70</th>
      <td>536</td>
      <td>45.0</td>
      <td>49.972924</td>
      <td>uncommon</td>
      <td>48.5</td>
    </tr>
    <tr>
      <th>71</th>
      <td>827</td>
      <td>1.0</td>
      <td>10.913917</td>
      <td>Master</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
<p>72 rows × 5 columns</p>
</div>




```python
fig, ax = plt.subplots(1, 2, figsize = (20, 8))
top_bar = mpatches.Patch(color = "darkblue", label = 'Age actual values')
middle_bar = mpatches.Patch(color = "red", label = 'Age predicted values by linear model')
low_bar = mpatches.Patch(color = "green", label = 'Age predicted values by medain values of each name title')

sns.lineplot(y = predict_result.age, x = predict_result.index, ax = ax[0], color = "darkblue", alpha = 0.8)
sns.lineplot(y = predict_result.predict_by_lm, x = predict_result.index, ax = ax[0], color = "red", alpha = 0.8)
sns.lineplot(y = predict_result.predict_by_medain_name_title, x = predict_result.index, ax = ax[0], color = "green", alpha = 0.8)
ax[0].set_xlabel("Index", fontsize = 14)
ax[0].set_ylabel("Age", fontsize = 14)
ax[0].set_title("Actual values vs. Prediced values (Not sorted)", fontsize = 18)
ax[0].legend(handles=[top_bar, middle_bar, low_bar])

sns.lineplot(y = predict_result.sort_values("age").age, x = predict_result.index, ax = ax[1], color = "darkblue", alpha = 0.8)
sns.lineplot(y = predict_result.sort_values("age").predict_by_lm, x = predict_result.index, ax = ax[1], color = "red", alpha = 0.8)
sns.lineplot(y = predict_result.sort_values("age").predict_by_medain_name_title, x = predict_result.index, ax = ax[1], color = "green", alpha = 0.8)
ax[1].set_xlabel("Index", fontsize = 14)
ax[1].set_ylabel("Age", fontsize = 14)
ax[1].set_title("Actual values vs. Prediced values (Sorted)", fontsize = 18)
ax[1].legend(handles=[top_bar, middle_bar, low_bar])

plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_225_0.png)
    


- Even if we predict with the median value of each title, some accurate prediction is possible, but we can confirm that the prediction using a linear model is more accurate.
Looking at the graph on the right where age is sorted, it can be seen that the accuracy of the linear model is better, especially in the age groups of children and the elderly, which have a great influence on the survival rate.       
    -> Let's impute missing values in age with the linear model


```python
X_missing_age = titanic[titanic.age.isnull()][["p_class", "num_sb_sp", "num_pr_ch", "ticket_fare", "num_cmp", "ticket_fare_category_order", "sex", "embark_port", "name_title"]]
X_missing_age
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_fare</th>
      <th>num_cmp</th>
      <th>ticket_fare_category_order</th>
      <th>sex</th>
      <th>embark_port</th>
      <th>name_title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>8.4583</td>
      <td>0</td>
      <td>1.0</td>
      <td>male</td>
      <td>Q</td>
      <td>Mr</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>13.0000</td>
      <td>0</td>
      <td>2.0</td>
      <td>male</td>
      <td>S</td>
      <td>Mr</td>
    </tr>
    <tr>
      <th>19</th>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>7.2250</td>
      <td>0</td>
      <td>1.0</td>
      <td>female</td>
      <td>C</td>
      <td>Mrs</td>
    </tr>
    <tr>
      <th>26</th>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>7.2250</td>
      <td>0</td>
      <td>1.0</td>
      <td>male</td>
      <td>C</td>
      <td>Mr</td>
    </tr>
    <tr>
      <th>28</th>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>7.8792</td>
      <td>0</td>
      <td>1.0</td>
      <td>female</td>
      <td>Q</td>
      <td>Miss</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>859</th>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>7.2292</td>
      <td>0</td>
      <td>1.0</td>
      <td>male</td>
      <td>C</td>
      <td>Mr</td>
    </tr>
    <tr>
      <th>863</th>
      <td>3</td>
      <td>8</td>
      <td>2</td>
      <td>69.5500</td>
      <td>10</td>
      <td>3.0</td>
      <td>female</td>
      <td>S</td>
      <td>Miss</td>
    </tr>
    <tr>
      <th>868</th>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>9.5000</td>
      <td>0</td>
      <td>2.0</td>
      <td>male</td>
      <td>S</td>
      <td>Mr</td>
    </tr>
    <tr>
      <th>878</th>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>7.8958</td>
      <td>0</td>
      <td>1.0</td>
      <td>male</td>
      <td>S</td>
      <td>Mr</td>
    </tr>
    <tr>
      <th>888</th>
      <td>3</td>
      <td>1</td>
      <td>2</td>
      <td>23.4500</td>
      <td>3</td>
      <td>2.0</td>
      <td>female</td>
      <td>S</td>
      <td>Miss</td>
    </tr>
  </tbody>
</table>
<p>173 rows × 9 columns</p>
</div>




```python
X_missing_age_prep = full_pipeline.transform(X_missing_age)
X_missing_age_prep
```




    array([[ 0.9065961 , -0.54282565, -0.51099538, ...,  1.        ,
             0.        ,  0.        ],
           [-0.28778188, -0.54282565, -0.51099538, ...,  1.        ,
             0.        ,  0.        ],
           [ 0.9065961 , -0.54282565, -0.51099538, ...,  0.        ,
             1.        ,  0.        ],
           ...,
           [ 0.9065961 , -0.54282565, -0.51099538, ...,  1.        ,
             0.        ,  0.        ],
           [ 0.9065961 , -0.54282565, -0.51099538, ...,  1.        ,
             0.        ,  0.        ],
           [ 0.9065961 ,  0.48553535,  1.83337959, ...,  0.        ,
             0.        ,  0.        ]])




```python
missing_age_prediction = lm.predict(X_missing_age_prep)
```


```python
titanic.loc[titanic.age.isnull(), "age"] = missing_age_prediction
```


```python
titanic.shape
```




    (891, 19)




```python
titanic[titanic.age.isnull()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
      <th>ticket_fare_category</th>
      <th>cabin_alphabet</th>
      <th>name_title</th>
      <th>age_category</th>
      <th>ticket_fare_category_order</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>



# 2. Data preparation

In the EDA, we have done some feature engineering. So, let's do the same process on the test data set.


```python
titanic.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
      <th>ticket_fare_category</th>
      <th>cabin_alphabet</th>
      <th>name_title</th>
      <th>age_category</th>
      <th>ticket_fare_category_order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
      <td>A/5</td>
      <td>21171</td>
      <td>1</td>
      <td>(4.010999999999999, 8.676]</td>
      <td>n</td>
      <td>Mr</td>
      <td>(16.336, 24.294]</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
      <td>PC</td>
      <td>17599</td>
      <td>1</td>
      <td>(26.25, 512.329]</td>
      <td>C</td>
      <td>Mrs</td>
      <td>(32.252, 40.21]</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
      <td>STON/O2.</td>
      <td>3101282</td>
      <td>0</td>
      <td>(4.010999999999999, 8.676]</td>
      <td>n</td>
      <td>Miss</td>
      <td>(24.294, 32.252]</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
      <td>non</td>
      <td>113803</td>
      <td>1</td>
      <td>(26.25, 512.329]</td>
      <td>C</td>
      <td>Mrs</td>
      <td>(32.252, 40.21]</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>373450</td>
      <td>0</td>
      <td>(4.010999999999999, 8.676]</td>
      <td>n</td>
      <td>Mr</td>
      <td>(32.252, 40.21]</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>



- Dependent variable: is_survived
- Independent variables:
    - p_class
    - name
        - name: do not use
        - name_title: use
    - sex: use
    - age
        - age: 
            - Fill missing values with name_title "Master" with mean age of passengers with "Master" name title 
            - After then, impute with linear model
        - age category: change to orderic variable age_category_order and use it instead of age_category
    - num_sb_sp
    - num_pr_ch
    - ticket_number: do not use
        - make num_cmp
    - ticket_fare
        - ticket_fare: use
        - ticket_fare_category: change to orderic variable ticket_fare_category_order and use it instead of ticket_fare_category
    - cabin_number: do not use
    - embark_port: 
        - impute with mode value


```python
test = pd.read_csv("./data/titanic_test.csv")
```


```python
# check missing values in test data set

test.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 418 entries, 0 to 417
    Data columns (total 11 columns):
     #   Column       Non-Null Count  Dtype  
    ---  ------       --------------  -----  
     0   PassengerId  418 non-null    int64  
     1   Pclass       418 non-null    int64  
     2   Name         418 non-null    object 
     3   Sex          418 non-null    object 
     4   Age          332 non-null    float64
     5   SibSp        418 non-null    int64  
     6   Parch        418 non-null    int64  
     7   Ticket       418 non-null    object 
     8   Fare         417 non-null    float64
     9   Cabin        91 non-null     object 
     10  Embarked     418 non-null    object 
    dtypes: float64(2), int64(4), object(5)
    memory usage: 36.0+ KB



```python
# Save passenger id sepeartely

test_passenger_id = test["PassengerId"]

test.drop("PassengerId", axis = 1, inplace = True)
test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>Kelly, Mr. James</td>
      <td>male</td>
      <td>34.5</td>
      <td>0</td>
      <td>0</td>
      <td>330911</td>
      <td>7.8292</td>
      <td>NaN</td>
      <td>Q</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>Wilkes, Mrs. James (Ellen Needs)</td>
      <td>female</td>
      <td>47.0</td>
      <td>1</td>
      <td>0</td>
      <td>363272</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Myles, Mr. Thomas Francis</td>
      <td>male</td>
      <td>62.0</td>
      <td>0</td>
      <td>0</td>
      <td>240276</td>
      <td>9.6875</td>
      <td>NaN</td>
      <td>Q</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Wirz, Mr. Albert</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>315154</td>
      <td>8.6625</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>Hirvonen, Mrs. Alexander (Helga E Lindqvist)</td>
      <td>female</td>
      <td>22.0</td>
      <td>1</td>
      <td>1</td>
      <td>3101298</td>
      <td>12.2875</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Set the column name same as the train data.

test.rename(columns = {"Survived" : "is_survived", 
                          "Pclass" : "p_class",
                          "Name" : "name",
                          "Sex" : "sex", 
                          "Age" : "age",
                          "SibSp" : "num_sb_sp",
                          "Parch" : "num_pr_ch",
                          "Ticket" : "ticket_number",
                          "Fare" : "ticket_fare",
                          "Cabin" : "cabin_number",
                          "Embarked" : "embark_port"}, inplace = True)
test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>Kelly, Mr. James</td>
      <td>male</td>
      <td>34.5</td>
      <td>0</td>
      <td>0</td>
      <td>330911</td>
      <td>7.8292</td>
      <td>NaN</td>
      <td>Q</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>Wilkes, Mrs. James (Ellen Needs)</td>
      <td>female</td>
      <td>47.0</td>
      <td>1</td>
      <td>0</td>
      <td>363272</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Myles, Mr. Thomas Francis</td>
      <td>male</td>
      <td>62.0</td>
      <td>0</td>
      <td>0</td>
      <td>240276</td>
      <td>9.6875</td>
      <td>NaN</td>
      <td>Q</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Wirz, Mr. Albert</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>315154</td>
      <td>8.6625</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>Hirvonen, Mrs. Alexander (Helga E Lindqvist)</td>
      <td>female</td>
      <td>22.0</td>
      <td>1</td>
      <td>1</td>
      <td>3101298</td>
      <td>12.2875</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Extract name_title

test["name_title"] = test.name.str.extract(' ([A-Za-z]+)\.', expand=False)
test['name_title'] = test['name_title'].replace(['Lady', 'Countess','Capt', 'Col', 'Don', 'Dr', 'Major', \
                                                 'Rev', 'Sir', 'Jonkheer', 'Dona'], 'uncommon')

test['name_title'] = test['name_title'].replace('Mlle', 'Miss')
test['name_title'] = test['name_title'].replace('Ms', 'Miss')
test['name_title'] = test['name_title'].replace('Mme', 'Mrs')
test.name_title.value_counts()
```




    Mr          240
    Miss         79
    Mrs          72
    Master       21
    uncommon      6
    Name: name_title, dtype: int64




```python
# make num_cmp by ticket number

test = test.merge(test["ticket_number"].value_counts().reset_index().rename(columns = {"index" : "ticket_number", "ticket_number" : "num_cmp_by_ticket"}), \
                        on = "ticket_number", how = "left")
test["num_cmp_by_ticket"] = test["num_cmp_by_ticket"] - 1
test["num_cmp_by_sb_sp_pr_ch"] = test["num_sb_sp"] + test["num_pr_ch"]
test["num_cmp"] = test[["num_cmp_by_ticket", "num_cmp_by_sb_sp_pr_ch"]].max(axis = 1)
test.drop(["num_cmp_by_ticket", "num_cmp_by_sb_sp_pr_ch"], axis = 1, inplace = True)
test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>name_title</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>Kelly, Mr. James</td>
      <td>male</td>
      <td>34.5</td>
      <td>0</td>
      <td>0</td>
      <td>330911</td>
      <td>7.8292</td>
      <td>NaN</td>
      <td>Q</td>
      <td>Mr</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>Wilkes, Mrs. James (Ellen Needs)</td>
      <td>female</td>
      <td>47.0</td>
      <td>1</td>
      <td>0</td>
      <td>363272</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>S</td>
      <td>Mrs</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Myles, Mr. Thomas Francis</td>
      <td>male</td>
      <td>62.0</td>
      <td>0</td>
      <td>0</td>
      <td>240276</td>
      <td>9.6875</td>
      <td>NaN</td>
      <td>Q</td>
      <td>Mr</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Wirz, Mr. Albert</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>315154</td>
      <td>8.6625</td>
      <td>NaN</td>
      <td>S</td>
      <td>Mr</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>Hirvonen, Mrs. Alexander (Helga E Lindqvist)</td>
      <td>female</td>
      <td>22.0</td>
      <td>1</td>
      <td>1</td>
      <td>3101298</td>
      <td>12.2875</td>
      <td>NaN</td>
      <td>S</td>
      <td>Mrs</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Impute 0 ticket fare with median value of each p_class

test.loc[(test.ticket_fare == 0) & (test.p_class == 1), "ticket_fare"] = p_class_fare_median[p_class_fare_median.p_class == 1].ticket_fare_median.values[0]
test.loc[(test.ticket_fare == 0) & (test.p_class == 2), "ticket_fare"] = p_class_fare_median[p_class_fare_median.p_class == 2].ticket_fare_median.values[0]
test.loc[(test.ticket_fare == 0) & (test.p_class == 3), "ticket_fare"] = p_class_fare_median[p_class_fare_median.p_class == 3].ticket_fare_median.values[0]
```


```python
test[test.ticket_fare == 0]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>name_title</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>




```python
test[test.ticket_fare.isnull()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>name_title</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>152</th>
      <td>3</td>
      <td>Storey, Mr. Thomas</td>
      <td>male</td>
      <td>60.5</td>
      <td>0</td>
      <td>0</td>
      <td>3701</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>S</td>
      <td>Mr</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
test["ticket_fare"] = test.ticket_fare.fillna(p_class_fare_median[p_class_fare_median.p_class == 3].ticket_fare_median.values[0])
```


```python
test[test.ticket_fare.isnull()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>name_title</th>
      <th>num_cmp</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>




```python
# Make ticket fare category order
```


```python
titanic.ticket_fare_category.unique()
```




    [(4.010999999999999, 8.676], (26.25, 512.329], (8.676, 26.25]]
    Categories (3, interval[float64, right]): [(4.010999999999999, 8.676] < (8.676, 26.25] < (26.25, 512.329]]




```python
test.loc[test['ticket_fare'] <= 8.676, 'ticket_fare_category_order'] = 1
test.loc[(test['ticket_fare'] > 8.676) & (test['ticket_fare'] <= 26.25), 'ticket_fare_category_order'] = 2
test.loc[test['ticket_fare'] > 26.25, 'ticket_fare_category_order'] = 3
```


```python
test.ticket_fare_category_order.value_counts()
```




    1.0    145
    2.0    140
    3.0    133
    Name: ticket_fare_category_order, dtype: int64




```python
np.sum(test.ticket_fare_category_order.value_counts())
```




    418




```python
np.sum(test.ticket_fare_category_order.isnull())
```




    0




```python
# Impute embark port with mode value : S

test[test.embark_port.isnull()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>name_title</th>
      <th>num_cmp</th>
      <th>ticket_fare_category_order</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>




```python
titanic.embark_port.unique()
```




    array(['S', 'C', 'Q'], dtype=object)




```python
# Fill missing values with name_title "Master" with mean age of passengers with "Master" name title 

test.loc[(test.name_title == "Master") & (test.age.isnull()), "age"] = np.mean(titanic[titanic.name_title == "Master"].age)
```


```python
test[(test.name_title == "Master") & (test.age.isnull())]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>name_title</th>
      <th>num_cmp</th>
      <th>ticket_fare_category_order</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>




```python
# Impute missing values in age with trained linear model
```


```python
X_missing_age = test[test.age.isnull()][["p_class", "num_sb_sp", "num_pr_ch", "ticket_fare", "num_cmp", "ticket_fare_category_order", "sex", "embark_port", "name_title"]]
X_missing_age_prep = full_pipeline.transform(X_missing_age)
missing_age_prediction = lm.predict(X_missing_age_prep)
test.loc[test.age.isnull(), "age"] = missing_age_prediction
```


```python
np.sum(test.age.isnull())
```




    0




```python
test.shape
```




    (418, 13)




```python
# Make age category order

titanic.age_category.value_counts()
```




    (16.336, 24.294]    177
    (24.294, 32.252]    169
    (32.252, 40.21]     118
    (40.21, 48.168]      70
    (0.34, 8.378]        54
    (8.378, 16.336]      46
    (48.168, 56.126]     45
    (56.126, 64.084]     24
    (64.084, 72.042]      9
    (72.042, 80.0]        2
    Name: age_category, dtype: int64




```python
test.loc[test['age'] <= 8.378, 'age_category_order'] = 1
test.loc[(test['age'] > 8.378) & (test['age'] <= 16.336), 'age_category_order'] = 2
test.loc[(test['age'] > 16.336) & (test['age'] <= 24.294), 'age_category_order'] = 3
test.loc[(test['age'] > 24.294) & (test['age'] <= 32.252), 'age_category_order'] = 4
test.loc[(test['age'] > 32.252) & (test['age'] <= 40.21), 'age_category_order'] = 5
test.loc[(test['age'] > 40.21) & (test['age'] <= 48.168), 'age_category_order'] = 6
test.loc[(test['age'] > 48.168) & (test['age'] <= 56.126), 'age_category_order'] = 7
test.loc[(test['age'] > 56.126) & (test['age'] <= 64.084), 'age_category_order'] = 8
test.loc[(test['age'] > 64.084) & (test['age'] <= 72.042), 'age_category_order'] = 9
test.loc[test['age'] > 72.042, 'age_category_order'] = 10

titanic.loc[titanic['age'] <= 8.378, 'age_category_order'] = 1
titanic.loc[(titanic['age'] > 8.378) & (titanic['age'] <= 16.336), 'age_category_order'] = 2
titanic.loc[(titanic['age'] > 16.336) & (titanic['age'] <= 24.294), 'age_category_order'] = 3
titanic.loc[(titanic['age'] > 24.294) & (titanic['age'] <= 32.252), 'age_category_order'] = 4
titanic.loc[(titanic['age'] > 32.252) & (titanic['age'] <= 40.21), 'age_category_order'] = 5
titanic.loc[(titanic['age'] > 40.21) & (titanic['age'] <= 48.168), 'age_category_order'] = 6
titanic.loc[(titanic['age'] > 48.168) & (titanic['age'] <= 56.126), 'age_category_order'] = 7
titanic.loc[(titanic['age'] > 56.126) & (titanic['age'] <= 64.084), 'age_category_order'] = 8
titanic.loc[(titanic['age'] > 64.084) & (titanic['age'] <= 72.042), 'age_category_order'] = 9
titanic.loc[titanic['age'] > 72.042, 'age_category_order'] = 10
```


```python
test.age_category_order.value_counts()
```




    4.0     122
    3.0     112
    5.0      59
    6.0      47
    1.0      23
    7.0      20
    8.0      17
    2.0      16
    9.0       1
    10.0      1
    Name: age_category_order, dtype: int64




```python
np.sum(test.age_category_order.value_counts())
```




    418




```python
np.sum(test.age_category_order.isnull())
```




    0




```python
np.sum(titanic.age_category_order.value_counts())
```




    891




```python
np.sum(titanic.age_category_order.isnull())
```




    0




```python
# Drop unused columns

test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>name_title</th>
      <th>num_cmp</th>
      <th>ticket_fare_category_order</th>
      <th>age_category_order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>Kelly, Mr. James</td>
      <td>male</td>
      <td>34.5</td>
      <td>0</td>
      <td>0</td>
      <td>330911</td>
      <td>7.8292</td>
      <td>NaN</td>
      <td>Q</td>
      <td>Mr</td>
      <td>0</td>
      <td>1.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>Wilkes, Mrs. James (Ellen Needs)</td>
      <td>female</td>
      <td>47.0</td>
      <td>1</td>
      <td>0</td>
      <td>363272</td>
      <td>7.0000</td>
      <td>NaN</td>
      <td>S</td>
      <td>Mrs</td>
      <td>1</td>
      <td>1.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Myles, Mr. Thomas Francis</td>
      <td>male</td>
      <td>62.0</td>
      <td>0</td>
      <td>0</td>
      <td>240276</td>
      <td>9.6875</td>
      <td>NaN</td>
      <td>Q</td>
      <td>Mr</td>
      <td>0</td>
      <td>2.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Wirz, Mr. Albert</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>315154</td>
      <td>8.6625</td>
      <td>NaN</td>
      <td>S</td>
      <td>Mr</td>
      <td>0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>Hirvonen, Mrs. Alexander (Helga E Lindqvist)</td>
      <td>female</td>
      <td>22.0</td>
      <td>1</td>
      <td>1</td>
      <td>3101298</td>
      <td>12.2875</td>
      <td>NaN</td>
      <td>S</td>
      <td>Mrs</td>
      <td>2</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
test.drop(["name", "ticket_number", "cabin_number"], axis = 1, inplace = True)
test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_fare</th>
      <th>embark_port</th>
      <th>name_title</th>
      <th>num_cmp</th>
      <th>ticket_fare_category_order</th>
      <th>age_category_order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>male</td>
      <td>34.5</td>
      <td>0</td>
      <td>0</td>
      <td>7.8292</td>
      <td>Q</td>
      <td>Mr</td>
      <td>0</td>
      <td>1.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>female</td>
      <td>47.0</td>
      <td>1</td>
      <td>0</td>
      <td>7.0000</td>
      <td>S</td>
      <td>Mrs</td>
      <td>1</td>
      <td>1.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>male</td>
      <td>62.0</td>
      <td>0</td>
      <td>0</td>
      <td>9.6875</td>
      <td>Q</td>
      <td>Mr</td>
      <td>0</td>
      <td>2.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>8.6625</td>
      <td>S</td>
      <td>Mr</td>
      <td>0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>female</td>
      <td>22.0</td>
      <td>1</td>
      <td>1</td>
      <td>12.2875</td>
      <td>S</td>
      <td>Mrs</td>
      <td>2</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
test.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 418 entries, 0 to 417
    Data columns (total 11 columns):
     #   Column                      Non-Null Count  Dtype  
    ---  ------                      --------------  -----  
     0   p_class                     418 non-null    int64  
     1   sex                         418 non-null    object 
     2   age                         418 non-null    float64
     3   num_sb_sp                   418 non-null    int64  
     4   num_pr_ch                   418 non-null    int64  
     5   ticket_fare                 418 non-null    float64
     6   embark_port                 418 non-null    object 
     7   name_title                  418 non-null    object 
     8   num_cmp                     418 non-null    int64  
     9   ticket_fare_category_order  418 non-null    float64
     10  age_category_order          418 non-null    float64
    dtypes: float64(4), int64(4), object(3)
    memory usage: 39.2+ KB



```python
titanic.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 891 entries, 0 to 890
    Data columns (total 20 columns):
     #   Column                      Non-Null Count  Dtype   
    ---  ------                      --------------  -----   
     0   is_survived                 891 non-null    int64   
     1   p_class                     891 non-null    int64   
     2   name                        891 non-null    object  
     3   sex                         891 non-null    object  
     4   age                         891 non-null    float64 
     5   num_sb_sp                   891 non-null    int64   
     6   num_pr_ch                   891 non-null    int64   
     7   ticket_number               891 non-null    object  
     8   ticket_fare                 891 non-null    float64 
     9   cabin_number                204 non-null    object  
     10  embark_port                 891 non-null    object  
     11  ticket_number_alphabet      891 non-null    object  
     12  ticket_number_number        891 non-null    object  
     13  num_cmp                     891 non-null    int64   
     14  ticket_fare_category        891 non-null    category
     15  cabin_alphabet              891 non-null    object  
     16  name_title                  891 non-null    object  
     17  age_category                714 non-null    category
     18  ticket_fare_category_order  891 non-null    float64 
     19  age_category_order          891 non-null    float64 
    dtypes: category(2), float64(4), int64(5), object(9)
    memory usage: 166.9+ KB


# 3. Modeling

## 3.1. Baseline model

Let's make baseline model with original columns.


```python
titanic_original = pd.read_csv("./data/titanic_train.csv")
```


```python
titanic_original.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PassengerId</th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Drop PassengerID that will not be used in modeling

titanic_original.drop("PassengerId", axis = 1, inplace = True)

# Change column name for just convenience

titanic_original.rename(columns = {"Survived" : "is_survived", 
                                   "Pclass" : "p_class",
                                   "Name" : "name",
                                   "Sex" : "sex", 
                                   "Age" : "age",
                                   "SibSp" : "num_sb_sp",
                                   "Parch" : "num_pr_ch",
                                   "Ticket" : "ticket_number",
                                   "Fare" : "ticket_fare",
                                   "Cabin" : "cabin_number",
                                   "Embarked" : "embark_port"}, inplace = True)
titanic_original.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Drop name, ticket_number, cabin_number columns that will not be used in modeling

titanic_original.drop(["name", "ticket_number", "cabin_number"], axis = 1, inplace = True)
```


```python
titanic_original.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 891 entries, 0 to 890
    Data columns (total 8 columns):
     #   Column       Non-Null Count  Dtype  
    ---  ------       --------------  -----  
     0   is_survived  891 non-null    int64  
     1   p_class      891 non-null    int64  
     2   sex          891 non-null    object 
     3   age          714 non-null    float64
     4   num_sb_sp    891 non-null    int64  
     5   num_pr_ch    891 non-null    int64  
     6   ticket_fare  891 non-null    float64
     7   embark_port  889 non-null    object 
    dtypes: float64(2), int64(4), object(2)
    memory usage: 55.8+ KB



```python
# Fill missing values in age just by mean of ages

titanic_original["age"] = titanic_original.age.fillna(np.mean(titanic_original.age))
np.sum(titanic_original.age.isnull())
```




    0




```python
# Fill missing values in embark_port just by mode of embark_ports

titanic_original["embark_port"] = titanic_original.embark_port.fillna(statistics.mode(titanic_original.embark_port))
np.sum(titanic_original.embark_port.isnull())
```




    0




```python
X = titanic_original.drop("is_survived", axis = 1)
y = titanic_original["is_survived"]
```


```python
num_features = ["p_class", "age", "num_sb_sp", "num_pr_ch", "ticket_fare"]
nonnum_features = ["sex", "embark_port"]
```


```python
full_pipeline = ColumnTransformer([
    ("num", StandardScaler(), num_features),
    ("nonnum", OneHotEncoder(), nonnum_features),
])
```


```python
X_original_prep = full_pipeline.fit_transform(X)
```


```python
X_train, X_test, y_train, y_test = train_test_split(X_original_prep, y, test_size = 0.1, random_state = 42)
```


```python
names = ["Nearest Neighbors", 
         "Linear SVM", 
         "RBF SVM", 
         "Gaussian Process",
         "Decision Tree", 
         "Random Forest", 
         "Neural Net", 
         "AdaBoost",
         "Naive Bayes"
        ]

classifiers = [
    KNeighborsClassifier(3),
    SVC(kernel="linear", C=0.025),
    SVC(gamma=2, C=1),
    GaussianProcessClassifier(1.0 * RBF(1.0)),
    DecisionTreeClassifier(max_depth=5),
    RandomForestClassifier(max_depth=5, n_estimators=10, max_features=1),
    MLPClassifier(alpha=1, max_iter=1000),
    AdaBoostClassifier(),
    GaussianNB(),
    ]
```


```python
result_accuracy = pd.DataFrame(names, columns = ["model_name"])
```


```python
for name, clf in zip(names, classifiers):
    try:
        clf.fit(X_train, y_train)
    except:
        clf.fit(X_train.toarray(), y_train)
    
    try:
        y_pred = clf.predict(X_test)
    except: 
        y_pred = clf.predict(X_test.toarray())
    
    # evaluate predictions
    try:
        accuracy = clf.score(X_test, y_test)
    except:
        accuracy = clf.score(X_test.toarray(), y_test)
    
    result_accuracy.loc[result_accuracy.model_name == name, "base_accuracy"] = round(accuracy * 100, 3)
    #print(f"{name} Accuracy: {round(accuracy * 100, 3)}")
```


```python
result_accuracy
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_name</th>
      <th>base_accuracy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Nearest Neighbors</td>
      <td>83.333</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Linear SVM</td>
      <td>81.111</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RBF SVM</td>
      <td>81.111</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Gaussian Process</td>
      <td>83.333</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Decision Tree</td>
      <td>76.667</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Random Forest</td>
      <td>82.222</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Neural Net</td>
      <td>76.667</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AdaBoost</td>
      <td>82.222</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Naive Bayes</td>
      <td>78.889</td>
    </tr>
  </tbody>
</table>
</div>



## 3.2. Dimension reduction + Classification

### PCA

Let's do PCA and use PC columns instead of original columns.


```python
X_prep.shape
```




    (718, 16)




```python
pipe = Pipeline([
    ('scale',StandardScaler()),
    ('pca', PCA(n_components = 10, random_state = 42)),
])
```


```python
X_pca = pipe.fit_transform(X_original_prep)
```


```python
plt.figure(figsize = (14, 8))

plt.bar(range(0,len(pipe.named_steps.pca.explained_variance_ratio_)), pipe.named_steps.pca.explained_variance_ratio_, alpha=0.5, align='center', label='Individual explained variance')
plt.step(range(0,len(np.cumsum(pipe.named_steps.pca.explained_variance_ratio_))), np.cumsum(pipe.named_steps.pca.explained_variance_ratio_), where='mid',label='Cumulative explained variance')
plt.ylabel('Explained variance ratio', fontsize = 14)
plt.xlabel('Principal component index', fontsize = 14)
plt.legend(loc = 'best')
plt.tight_layout()
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_298_0.png)
    


- 4 PC variables can explain almost 80% of total variance.


```python
X_pca[:, :2].shape
```




    (891, 2)




```python
X_pca_scatter = pd.concat([pd.DataFrame(X_pca[:, :2], columns = ["PC1", "PC2"]), pd.DataFrame(titanic_original.is_survived, columns = ["is_survived"])], axis = 1)
X_pca_scatter.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PC1</th>
      <th>PC2</th>
      <th>is_survived</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-1.549197</td>
      <td>-0.628395</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3.156084</td>
      <td>1.732145</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.455716</td>
      <td>-1.295524</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.562384</td>
      <td>-0.519725</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-1.695137</td>
      <td>0.025692</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize = (14, 8))
sns.scatterplot(data = X_pca_scatter, x = "PC1", y = "PC2", hue = "is_survived")
plt.xlabel("PC1", fontsize = 14)
plt.ylabel("PC2", fontsize = 14)
plt.show()
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_302_0.png)
    


- It can be seen that we can classify well with PC1, PC2 values.     
    -> Let's do classification with PC1, PC2 variables.



```python
X_pca[:, :2].shape
```




    (891, 2)




```python
X_pca_prep = X_pca[:, :2]
```


```python
X_train, X_test, y_train, y_test = train_test_split(X_pca_prep, y, test_size = 0.1, random_state = 42)
```


```python
names = ["Nearest Neighbors", 
         "Linear SVM", 
         "RBF SVM", 
         "Gaussian Process",
         "Decision Tree", 
         "Random Forest", 
         "Neural Net", 
         "AdaBoost",
         "Naive Bayes"
        ]

classifiers = [
    KNeighborsClassifier(3),
    SVC(kernel="linear", C=0.025),
    SVC(gamma=2, C=1),
    GaussianProcessClassifier(1.0 * RBF(1.0)),
    DecisionTreeClassifier(max_depth=5),
    RandomForestClassifier(max_depth=5, n_estimators=10, max_features=1),
    MLPClassifier(alpha=1, max_iter=1000),
    AdaBoostClassifier(),
    GaussianNB(),
    ]
```


```python
for name, clf in zip(names, classifiers):
    try:
        clf.fit(X_train, y_train)
    except:
        clf.fit(X_train.toarray(), y_train)
    
    try:
        y_pred = clf.predict(X_test)
    except: 
        y_pred = clf.predict(X_test.toarray())
    
    # evaluate predictions
    try:
        accuracy = clf.score(X_test, y_test)
    except:
        accuracy = clf.score(X_test.toarray(), y_test)
    
    result_accuracy.loc[result_accuracy.model_name == name, "pca_accuracy"] = round(accuracy * 100, 3)
    #print(f"{name} Accuracy: {round(accuracy * 100, 3)}")
```


```python
result_accuracy
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_name</th>
      <th>base_accuracy</th>
      <th>pca_accuracy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Nearest Neighbors</td>
      <td>83.333</td>
      <td>81.111</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Linear SVM</td>
      <td>81.111</td>
      <td>80.000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RBF SVM</td>
      <td>81.111</td>
      <td>82.222</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Gaussian Process</td>
      <td>83.333</td>
      <td>80.000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Decision Tree</td>
      <td>76.667</td>
      <td>82.222</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Random Forest</td>
      <td>82.222</td>
      <td>81.111</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Neural Net</td>
      <td>76.667</td>
      <td>78.889</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AdaBoost</td>
      <td>82.222</td>
      <td>78.889</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Naive Bayes</td>
      <td>78.889</td>
      <td>81.111</td>
    </tr>
  </tbody>
</table>
</div>



- By using only PC1 and PC2 variables, we can obtain as high accuracy as baseline models.     
- In some models like RBF SVM, Decision Tree, Neural Net, Naive Bayes, PCA variables got higher accuracy than baseline models.

### TSNE

Let's do TSNE and use variabels from TSNE instead of original columns.


```python
X_original_prep.shape
```




    (891, 10)




```python
fig, ax = plt.subplots(3, 2, figsize = (15, 20))
for i, perplexity in enumerate([1, 5, 10, 15, 25, 35]):
    tsne = TSNE(n_components = 2, random_state = 42, perplexity = perplexity)
    X_2d = tsne.fit_transform(X_original_prep)
    tsne_labelled = pd.concat([pd.DataFrame(X_2d, columns = ["d1", "d2"]), titanic_original[["is_survived"]].astype(str)], axis = 1)
    
    sns.scatterplot(data = tsne_labelled, x = "d1", y = "d2", hue = "is_survived", ax = ax[i // 2, i % 2])
    ax[i // 2, i % 2].set_title(f"Perplexity = {perplexity}", fontsize = 14)
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_314_0.png)
    


- From perplexity 15, we can figure out some distinct clusters. And some clusters have a higher rate of survival.      
    -> Let's use higher perplexities.


```python
fig, ax = plt.subplots(3, 2, figsize = (15, 20))
for i, perplexity in enumerate([15, 25, 30, 35, 40, 45]):
    tsne = TSNE(n_components = 2, random_state = 42, perplexity = perplexity)
    X_2d = tsne.fit_transform(X_original_prep)
    tsne_labelled = pd.concat([pd.DataFrame(X_2d, columns = ["d1", "d2"]), titanic_original[["is_survived"]].astype(str)], axis = 1)
    
    sns.scatterplot(data = tsne_labelled, x = "d1", y = "d2", hue = "is_survived", ax = ax[i // 2, i % 2])
    ax[i // 2, i % 2].set_title(f"Perplexity = {perplexity}", fontsize = 14)
```


    
![png](/assets/images/coursework/SI618/hw7/hw7_upload_316_0.png)
    


- From 15, the results are almost similar to each other.
- When perplexity is 25, the distinction between clusters was clear.   
    -> Let's use perplexity = 25


```python
tsne = TSNE(n_components = 2, random_state = 42, perplexity = 25)
X_tsne_prep = tsne.fit_transform(X_original_prep)
```


```python
X_train, X_test, y_train, y_test = train_test_split(X_tsne_prep, y, test_size = 0.1, random_state = 42)
```


```python
names = ["Nearest Neighbors", 
         "Linear SVM", 
         "RBF SVM", 
         "Gaussian Process",
         "Decision Tree", 
         "Random Forest", 
         "Neural Net", 
         "AdaBoost",
         "Naive Bayes"
        ]

classifiers = [
    KNeighborsClassifier(3),
    SVC(kernel="linear", C=0.025),
    SVC(gamma=2, C=1),
    GaussianProcessClassifier(1.0 * RBF(1.0)),
    DecisionTreeClassifier(max_depth=5),
    RandomForestClassifier(max_depth=5, n_estimators=10, max_features=1),
    MLPClassifier(alpha=1, max_iter=1000),
    AdaBoostClassifier(),
    GaussianNB(),
    ]

for name, clf in zip(names, classifiers):
    try:
        clf.fit(X_train, y_train)
    except:
        clf.fit(X_train.toarray(), y_train)
    
    try:
        y_pred = clf.predict(X_test)
    except: 
        y_pred = clf.predict(X_test.toarray())
    
    # evaluate predictions
    try:
        accuracy = clf.score(X_test, y_test)
    except:
        accuracy = clf.score(X_test.toarray(), y_test)
    
    result_accuracy.loc[result_accuracy.model_name == name, "tsne_accuracy"] = round(accuracy * 100, 3)
    #print(f"{name} Accuracy: {round(accuracy * 100, 3)}")
```


```python
result_accuracy
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_name</th>
      <th>base_accuracy</th>
      <th>pca_accuracy</th>
      <th>tsne_accuracy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Nearest Neighbors</td>
      <td>83.333</td>
      <td>81.111</td>
      <td>81.111</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Linear SVM</td>
      <td>81.111</td>
      <td>80.000</td>
      <td>73.333</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RBF SVM</td>
      <td>81.111</td>
      <td>82.222</td>
      <td>81.111</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Gaussian Process</td>
      <td>83.333</td>
      <td>80.000</td>
      <td>82.222</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Decision Tree</td>
      <td>76.667</td>
      <td>82.222</td>
      <td>83.333</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Random Forest</td>
      <td>82.222</td>
      <td>81.111</td>
      <td>83.333</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Neural Net</td>
      <td>76.667</td>
      <td>78.889</td>
      <td>76.667</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AdaBoost</td>
      <td>82.222</td>
      <td>78.889</td>
      <td>76.667</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Naive Bayes</td>
      <td>78.889</td>
      <td>81.111</td>
      <td>73.333</td>
    </tr>
  </tbody>
</table>
</div>



- By using only 2 variables from tsne, we can obtain as high accuracy as baseline models.
- In Decision Tree and Random Forest, tsne variables got the highest accuracy than baseline or PCA models.

## 3.3. EDA variables

Now, let's use variables from EDA and compare the accuracy with accuracies from methods used before.


```python
titanic.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_survived</th>
      <th>p_class</th>
      <th>name</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_number</th>
      <th>ticket_fare</th>
      <th>cabin_number</th>
      <th>embark_port</th>
      <th>ticket_number_alphabet</th>
      <th>ticket_number_number</th>
      <th>num_cmp</th>
      <th>ticket_fare_category</th>
      <th>cabin_alphabet</th>
      <th>name_title</th>
      <th>age_category</th>
      <th>ticket_fare_category_order</th>
      <th>age_category_order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
      <td>A/5</td>
      <td>21171</td>
      <td>1</td>
      <td>(4.010999999999999, 8.676]</td>
      <td>n</td>
      <td>Mr</td>
      <td>(16.336, 24.294]</td>
      <td>1.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
      <td>PC</td>
      <td>17599</td>
      <td>1</td>
      <td>(26.25, 512.329]</td>
      <td>C</td>
      <td>Mrs</td>
      <td>(32.252, 40.21]</td>
      <td>3.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
      <td>STON/O2.</td>
      <td>3101282</td>
      <td>0</td>
      <td>(4.010999999999999, 8.676]</td>
      <td>n</td>
      <td>Miss</td>
      <td>(24.294, 32.252]</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
      <td>non</td>
      <td>113803</td>
      <td>1</td>
      <td>(26.25, 512.329]</td>
      <td>C</td>
      <td>Mrs</td>
      <td>(32.252, 40.21]</td>
      <td>3.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
      <td>non</td>
      <td>373450</td>
      <td>0</td>
      <td>(4.010999999999999, 8.676]</td>
      <td>n</td>
      <td>Mr</td>
      <td>(32.252, 40.21]</td>
      <td>1.0</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
titanic.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 891 entries, 0 to 890
    Data columns (total 20 columns):
     #   Column                      Non-Null Count  Dtype   
    ---  ------                      --------------  -----   
     0   is_survived                 891 non-null    int64   
     1   p_class                     891 non-null    int64   
     2   name                        891 non-null    object  
     3   sex                         891 non-null    object  
     4   age                         891 non-null    float64 
     5   num_sb_sp                   891 non-null    int64   
     6   num_pr_ch                   891 non-null    int64   
     7   ticket_number               891 non-null    object  
     8   ticket_fare                 891 non-null    float64 
     9   cabin_number                204 non-null    object  
     10  embark_port                 891 non-null    object  
     11  ticket_number_alphabet      891 non-null    object  
     12  ticket_number_number        891 non-null    object  
     13  num_cmp                     891 non-null    int64   
     14  ticket_fare_category        891 non-null    category
     15  cabin_alphabet              891 non-null    object  
     16  name_title                  891 non-null    object  
     17  age_category                714 non-null    category
     18  ticket_fare_category_order  891 non-null    float64 
     19  age_category_order          891 non-null    float64 
    dtypes: category(2), float64(4), int64(5), object(9)
    memory usage: 166.9+ KB



```python
X = titanic.drop(["is_survived", "name", "ticket_number", "cabin_number", "ticket_number_alphabet", \
                  "ticket_number_number", "cabin_alphabet", "ticket_fare_category", "age_category"], axis = 1)
y = titanic["is_survived"]
```


```python
X
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_fare</th>
      <th>embark_port</th>
      <th>num_cmp</th>
      <th>name_title</th>
      <th>ticket_fare_category_order</th>
      <th>age_category_order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>male</td>
      <td>22.000000</td>
      <td>1</td>
      <td>0</td>
      <td>7.2500</td>
      <td>S</td>
      <td>1</td>
      <td>Mr</td>
      <td>1.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>female</td>
      <td>38.000000</td>
      <td>1</td>
      <td>0</td>
      <td>71.2833</td>
      <td>C</td>
      <td>1</td>
      <td>Mrs</td>
      <td>3.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>female</td>
      <td>26.000000</td>
      <td>0</td>
      <td>0</td>
      <td>7.9250</td>
      <td>S</td>
      <td>0</td>
      <td>Miss</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>female</td>
      <td>35.000000</td>
      <td>1</td>
      <td>0</td>
      <td>53.1000</td>
      <td>S</td>
      <td>1</td>
      <td>Mrs</td>
      <td>3.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>male</td>
      <td>35.000000</td>
      <td>0</td>
      <td>0</td>
      <td>8.0500</td>
      <td>S</td>
      <td>0</td>
      <td>Mr</td>
      <td>1.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>886</th>
      <td>2</td>
      <td>male</td>
      <td>27.000000</td>
      <td>0</td>
      <td>0</td>
      <td>13.0000</td>
      <td>S</td>
      <td>0</td>
      <td>uncommon</td>
      <td>2.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>887</th>
      <td>1</td>
      <td>female</td>
      <td>19.000000</td>
      <td>0</td>
      <td>0</td>
      <td>30.0000</td>
      <td>S</td>
      <td>0</td>
      <td>Miss</td>
      <td>3.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>888</th>
      <td>3</td>
      <td>female</td>
      <td>15.685263</td>
      <td>1</td>
      <td>2</td>
      <td>23.4500</td>
      <td>S</td>
      <td>3</td>
      <td>Miss</td>
      <td>2.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>889</th>
      <td>1</td>
      <td>male</td>
      <td>26.000000</td>
      <td>0</td>
      <td>0</td>
      <td>30.0000</td>
      <td>C</td>
      <td>0</td>
      <td>Mr</td>
      <td>3.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>890</th>
      <td>3</td>
      <td>male</td>
      <td>32.000000</td>
      <td>0</td>
      <td>0</td>
      <td>7.7500</td>
      <td>Q</td>
      <td>0</td>
      <td>Mr</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
<p>891 rows × 11 columns</p>
</div>




```python
num_features = ["p_class", "age", "num_sb_sp", "num_pr_ch", "ticket_fare", "num_cmp", "ticket_fare_category_order", "age_category_order"]
nonnum_features = ["sex", "embark_port", "name_title"]
```


```python
full_pipeline = ColumnTransformer([
    ("num", StandardScaler(), num_features),
    ("nonnum", OneHotEncoder(), nonnum_features),
])
```


```python
X_eda_prep = full_pipeline.fit_transform(X)
```


```python
X_train, X_test, y_train, y_test = train_test_split(X_eda_prep, y, test_size = 0.1, random_state = 42)
```


```python
names = ["Nearest Neighbors", 
         "Linear SVM", 
         "RBF SVM", 
         "Gaussian Process",
         "Decision Tree", 
         "Random Forest", 
         "Neural Net", 
         "AdaBoost",
         "Naive Bayes"
        ]

classifiers = [
    KNeighborsClassifier(3),
    SVC(kernel="linear", C=0.025),
    SVC(gamma=2, C=1),
    GaussianProcessClassifier(1.0 * RBF(1.0)),
    DecisionTreeClassifier(max_depth=5),
    RandomForestClassifier(max_depth=5, n_estimators=10, max_features=1),
    MLPClassifier(alpha=1, max_iter=1000),
    AdaBoostClassifier(),
    GaussianNB(),
    ]
```


```python
for name, clf in zip(names, classifiers):
    try:
        clf.fit(X_train, y_train)
    except:
        clf.fit(X_train.toarray(), y_train)
    
    try:
        y_pred = clf.predict(X_test)
    except: 
        y_pred = clf.predict(X_test.toarray())
    
    # evaluate predictions
    try:
        accuracy = clf.score(X_test, y_test)
    except:
        accuracy = clf.score(X_test.toarray(), y_test)
    
    result_accuracy.loc[result_accuracy.model_name == name, "eda_variables"] = round(accuracy * 100, 3)
    #print(f"{name} Accuracy: {round(accuracy * 100, 3)}")
```


```python
result_accuracy
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_name</th>
      <th>base_accuracy</th>
      <th>pca_accuracy</th>
      <th>tsne_accuracy</th>
      <th>eda_variables</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Nearest Neighbors</td>
      <td>83.333</td>
      <td>81.111</td>
      <td>81.111</td>
      <td>84.444</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Linear SVM</td>
      <td>81.111</td>
      <td>80.000</td>
      <td>73.333</td>
      <td>82.222</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RBF SVM</td>
      <td>81.111</td>
      <td>82.222</td>
      <td>81.111</td>
      <td>80.000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Gaussian Process</td>
      <td>83.333</td>
      <td>80.000</td>
      <td>82.222</td>
      <td>84.444</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Decision Tree</td>
      <td>76.667</td>
      <td>82.222</td>
      <td>83.333</td>
      <td>83.333</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Random Forest</td>
      <td>82.222</td>
      <td>81.111</td>
      <td>83.333</td>
      <td>80.000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Neural Net</td>
      <td>76.667</td>
      <td>78.889</td>
      <td>76.667</td>
      <td>80.000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AdaBoost</td>
      <td>82.222</td>
      <td>78.889</td>
      <td>76.667</td>
      <td>82.222</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Naive Bayes</td>
      <td>78.889</td>
      <td>81.111</td>
      <td>73.333</td>
      <td>78.889</td>
    </tr>
  </tbody>
</table>
</div>



- In Nearest Neighbors, Linear SVM, Gaussian Process, AdaBoost, eda variables got the highest accuracy than other methods.      
    -> Let's tune Nearest Neighbors, Linear SVM, Gaussian Process, Deicision Tree, and Random Forest and ensemble these models.

## 3.4. Hyperparameter Tuning

Let's tune the hyperparameters for each of 5 models that I will use: Nearest Neighbors, Linear SVM, Gaussian Process, Deicision Tree, and Random Forest.

### Nearest Neighbors


```python
param_grid = {
    'leaf_size': [1, 3, 5, 7, 9],
    'n_neighbors': [1, 3, 5, 7, 9],
    'p' : [1,2]
}

model = KNeighborsClassifier()

eda_knn_grid = GridSearchCV(model, param_grid, cv = 5, n_jobs = -1)
eda_knn_grid.fit(X_eda_prep, y)

print(eda_knn_grid.best_estimator_)
print(eda_knn_grid.best_score_)
```

    KNeighborsClassifier(leaf_size=1, n_neighbors=7)
    0.8237838177138912


- Best parameters: leaf_size = 1, n_neighbors = 7
- Best score: about 82%

### Linear SVM


```python
param_grid = {
    'C': [0.1, 1, 10, 100],
    'gamma': [1, 0.1, 0.01],
}

model = SVC(kernel = "linear")

eda_svm_grid = GridSearchCV(model, param_grid, cv = 5, n_jobs = -1)
eda_svm_grid.fit(X_eda_prep, y)

print(eda_svm_grid.best_estimator_)
print(eda_svm_grid.best_score_)
```

    SVC(C=0.1, gamma=1, kernel='linear')
    0.8248948590797817


- Best parameters: c = 0.1, gamma = 1
- Best score: about 82%

### Gaussian Process


```python
param_grid = {
    "kernel": [1 * RBF(), 1 * DotProduct(), 1 * Matern(),  1 * RationalQuadratic(), 1 * WhiteKernel()]
}

model = GaussianProcessClassifier()

eda_gaussian_grid = GridSearchCV(model, param_grid, cv = 5, n_jobs = -1)
eda_gaussian_grid.fit(X_eda_prep, y)

print(eda_gaussian_grid.best_estimator_)
print(eda_gaussian_grid.best_score_)
```

    /opt/anaconda3/lib/python3.9/site-packages/sklearn/gaussian_process/kernels.py:411: ConvergenceWarning: The optimal value found for dimension 0 of parameter k2__alpha is close to the specified upper bound 100000.0. Increasing the bound and calling fit again may find a better value.
      warnings.warn("The optimal value found for "
    /opt/anaconda3/lib/python3.9/site-packages/sklearn/gaussian_process/kernels.py:411: ConvergenceWarning: The optimal value found for dimension 0 of parameter k2__alpha is close to the specified upper bound 100000.0. Increasing the bound and calling fit again may find a better value.
      warnings.warn("The optimal value found for "


    GaussianProcessClassifier(kernel=1**2 * RBF(length_scale=1))
    0.8271608813006089


- Best parameters: kernel = 1 ** 2 * RBF(length_scale = 1)
- Best score: about 83%

### Decision tree


```python
param_grid = {
    "splitter":["best","random"],
    "max_depth" : [1,3,5,7,9],
    "min_samples_leaf":[1,2,3],
    "min_weight_fraction_leaf":[0.1,0.2,0.3,0.4],
    "max_features":["auto","log2","sqrt",None],
    "max_leaf_nodes":[None, 20, 40, 60]
}

model = DecisionTreeClassifier()

eda_decision_tree_grid = GridSearchCV(model, param_grid, cv = 5, n_jobs = -1)
eda_decision_tree_grid.fit(X_eda_prep, y)

print(eda_decision_tree_grid.best_estimator_)
print(eda_decision_tree_grid.best_score_)
```

    DecisionTreeClassifier(max_depth=9, max_features='auto', max_leaf_nodes=40,
                           min_samples_leaf=2, min_weight_fraction_leaf=0.2)
    0.7968740192078337


- Best parameters: max_depth = 7, max_features = "sqrt", max_leaf_nodes = 60, min_samples_leaf = 3, min_weight_fraction_leaf = 0.1
- Best score: about 80%

### Random forest


```python
param_grid = {
    'bootstrap': [True, False],
    'max_depth': [10, 30, 50],
    'max_features': ['auto', 'sqrt'],
    'min_samples_leaf': [1, 2, 4],
    'min_samples_split': [2, 5, 10],
    'n_estimators': [5, 10, 15, 20]
}

model = RandomForestClassifier()

eda_random_forest_grid = GridSearchCV(model, param_grid, cv = 5, n_jobs = -1)
eda_random_forest_grid.fit(X_eda_prep, y)

print(eda_random_forest_grid.best_estimator_)
print(eda_random_forest_grid.best_score_)
```

    RandomForestClassifier(max_depth=30, max_features='sqrt', min_samples_leaf=2,
                           min_samples_split=5, n_estimators=20)
    0.8439834285355596


- Best parameters: bootstrap = False, max_depth = 10, miin_samples_leaf = 4, min_samples_split = 10, n_estimators = 15
- Best score: about 85%

## 3.5. Ensemble Models

Now, let's tune classfiers and ensemble these models.

### Nearest Neighbors, Linear SVM, Gaussian Process


```python
X = titanic.drop(["is_survived", "name", "ticket_number", "cabin_number", "ticket_number_alphabet", \
                  "ticket_number_number", "cabin_alphabet", "ticket_fare_category", "age_category"], axis = 1)
y = titanic["is_survived"]
```


```python
num_features = ["p_class", "age", "num_sb_sp", "num_pr_ch", "ticket_fare", "num_cmp", "ticket_fare_category_order", "age_category_order"]
nonnum_features = ["sex", "embark_port", "name_title"]
```


```python
full_pipeline = ColumnTransformer([
    ("num", StandardScaler(), num_features),
    ("nonnum", OneHotEncoder(), nonnum_features),
])
```


```python
X_eda_prep = full_pipeline.fit_transform(X)
```


```python
X_train, X_test, y_train, y_test = train_test_split(X_eda_prep, y, test_size = 0.1, random_state = 42)

```


```python
clf_knn = KNeighborsClassifier(leaf_size = eda_knn_grid.best_params_["leaf_size"], n_neighbors = eda_knn_grid.best_params_["n_neighbors"])

clf_svc = SVC(kernel = "linear", C = eda_svm_grid.best_params_["C"], gamma = eda_svm_grid.best_params_["gamma"])

clf_gaussian_process = GaussianProcessClassifier(kernel = eda_gaussian_grid.best_params_["kernel"])


clf_decision_tree = DecisionTreeClassifier(
    max_depth = eda_decision_tree_grid.best_params_["max_depth"],
    max_features = eda_decision_tree_grid.best_params_["max_features"],
    max_leaf_nodes = eda_decision_tree_grid.best_params_["max_leaf_nodes"],
    min_samples_leaf = eda_decision_tree_grid.best_params_["min_samples_leaf"],
    min_weight_fraction_leaf = eda_decision_tree_grid.best_params_["min_weight_fraction_leaf"],
    splitter = eda_decision_tree_grid.best_params_["splitter"],
)

clf_random_forest = RandomForestClassifier(
    bootstrap = eda_random_forest_grid.best_params_["bootstrap"],
    max_depth = eda_random_forest_grid.best_params_["max_depth"],
    max_features = eda_random_forest_grid.best_params_["max_features"],
    min_samples_leaf = eda_random_forest_grid.best_params_["min_samples_leaf"],
    min_samples_split = eda_random_forest_grid.best_params_["min_samples_split"],
    n_estimators = eda_random_forest_grid.best_params_["n_estimators"],
)
```


```python
clf_ensemble = VotingClassifier(
    estimators = [("knn", clf_knn), ("svc", clf_svc), ("gp", clf_gaussian_process),
                  ("dt", clf_decision_tree), ("rf", clf_random_forest)], 
    voting = "hard"
)
```


```python
clf_ensemble = clf_ensemble.fit(X_train, y_train)
y_pred = clf_ensemble.predict(X_test)
accuracy = clf_ensemble.score(X_test, y_test)

round(accuracy * 100, 3)
```




    82.222



- Get about 82% accuracy from the ensemble model.

# 4. Prepare submission


```python
X.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_fare</th>
      <th>embark_port</th>
      <th>num_cmp</th>
      <th>name_title</th>
      <th>ticket_fare_category_order</th>
      <th>age_category_order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>7.2500</td>
      <td>S</td>
      <td>1</td>
      <td>Mr</td>
      <td>1.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>71.2833</td>
      <td>C</td>
      <td>1</td>
      <td>Mrs</td>
      <td>3.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>7.9250</td>
      <td>S</td>
      <td>0</td>
      <td>Miss</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>53.1000</td>
      <td>S</td>
      <td>1</td>
      <td>Mrs</td>
      <td>3.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>8.0500</td>
      <td>S</td>
      <td>0</td>
      <td>Mr</td>
      <td>1.0</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
test = test[X.columns]
test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p_class</th>
      <th>sex</th>
      <th>age</th>
      <th>num_sb_sp</th>
      <th>num_pr_ch</th>
      <th>ticket_fare</th>
      <th>embark_port</th>
      <th>num_cmp</th>
      <th>name_title</th>
      <th>ticket_fare_category_order</th>
      <th>age_category_order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>male</td>
      <td>34.5</td>
      <td>0</td>
      <td>0</td>
      <td>7.8292</td>
      <td>Q</td>
      <td>0</td>
      <td>Mr</td>
      <td>1.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>female</td>
      <td>47.0</td>
      <td>1</td>
      <td>0</td>
      <td>7.0000</td>
      <td>S</td>
      <td>1</td>
      <td>Mrs</td>
      <td>1.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>male</td>
      <td>62.0</td>
      <td>0</td>
      <td>0</td>
      <td>9.6875</td>
      <td>Q</td>
      <td>0</td>
      <td>Mr</td>
      <td>2.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>male</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>8.6625</td>
      <td>S</td>
      <td>0</td>
      <td>Mr</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>female</td>
      <td>22.0</td>
      <td>1</td>
      <td>1</td>
      <td>12.2875</td>
      <td>S</td>
      <td>2</td>
      <td>Mrs</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
test.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 418 entries, 0 to 417
    Data columns (total 11 columns):
     #   Column                      Non-Null Count  Dtype  
    ---  ------                      --------------  -----  
     0   p_class                     418 non-null    int64  
     1   sex                         418 non-null    object 
     2   age                         418 non-null    float64
     3   num_sb_sp                   418 non-null    int64  
     4   num_pr_ch                   418 non-null    int64  
     5   ticket_fare                 418 non-null    float64
     6   embark_port                 418 non-null    object 
     7   num_cmp                     418 non-null    int64  
     8   name_title                  418 non-null    object 
     9   ticket_fare_category_order  418 non-null    float64
     10  age_category_order          418 non-null    float64
    dtypes: float64(4), int64(4), object(3)
    memory usage: 39.2+ KB



```python
X_submission_prep = full_pipeline.transform(test)
```


```python
y_pred = clf_ensemble.predict(X_submission_prep)
```


```python
submission = pd.DataFrame({
    "PassengerId": test_passenger_id,
    "Survived": y_pred
})

submission.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PassengerId</th>
      <th>Survived</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>892</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>893</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>894</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>895</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>896</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
#submission.to_csv('./data/titanic_submission.csv', index=False)
```

![title](titanic_submission.png)
