---
layout: single
title: "7-2. Inference Components and Evaluation Metrics for Object Detection"
permalink: /coursework/EECS504/hw7-2/
comments: false
author_profile: true
read_time: true
toc: true
toc_label: "Table of Contents"
toc_sticky: true
categories: ["EECS504"]
---

**Topics: Object detection, IoU, NMS, mAP**

---

# Problem: Inference Components and Evaluation Metrics for Object Detection

In this part of the assignment, you will implement the inference and evaluation metrics required for Object Detection. 

You will be implementing **IoU**, **NMS** and **mAP**


```python
# We will import some libraries we need
import math
import torch
import torch.nn as nn
import torch.nn.functional as F
from torch.utils.data._utils.collate import default_collate
from torch import optim
from torchvision import transforms
import torchvision
from torchvision import models
from torchvision.models import feature_extraction
from torchvision.ops import nms

import matplotlib.pyplot as plt
import numpy as np
import os
import time
import random
from collections import Counter
!pip -q install torchmetrics
```

We will use GPUs to accelerate our computation in this notebook. Run the following to make sure GPUs are enabled:


```python
if torch.cuda.is_available():
    print('Good to go!')
    DEVICE = torch.device("cuda")
else:
    print('Please set GPU via Edit -> Notebook Settings.')
    DEVICE = torch.device("cpu")
```

    Good to go!



```python
def reset_seed(number):
    """
    Reset random seed to the specific number

    Inputs:
    - number: A seed number to use
    """
    random.seed(number)
    torch.manual_seed(number)
    return
```


```python
def rel_error(x, y, eps=1e-10):
    """
    Compute the relative error between a pair of tensors x and y,
    which is defined as:

                            max_i |x_i - y_i]|
    rel_error(x, y) = -------------------------------
                      max_i |x_i| + max_i |y_i| + eps

    Inputs:
    - x, y: Tensors of the same shape
    - eps: Small positive constant for numeric stability

    Returns:
    - rel_error: Scalar giving the relative error between x and y
    """
    """ returns relative error between x and y """
    top = (x - y).abs().max().item()
    bot = (x.abs() + y.abs()).clamp(min=eps).max().item()
    return top / bot
```

## (a) Intersection Over Union (IoU)

Your first task is to implement the IoU function, which estimates the intersection-over- union (IoU) of two bounding boxes (also called the Jaccard similarity). Recall that IoU for two boxes B1 and B2 is:

$$
IoU(B_1, B_2) = \frac{|B_1 \cap B_2|}{|B_1 \cup B_2|}
$$

This function is used to calculate the IoU between the predicted and ground-truth bounding boxes. It wil be used as part of your implementation of the mAP function, and used in the Generalized IoU loss function in the object detection model.

Implement the `intersection_over_union` function given below. We will then compare your implementation of IoU with a toy example. We will later reuse your IoU implementation for computing mean average precision (mAP).


```python
def intersection_over_union(boxes1: torch.Tensor, boxes2: torch.Tensor) -> torch.Tensor:
    """
    Compute intersection-over-union (IoU) between pairs of box tensors. Input
    box tensors must in XYXY format.

    Args:
        boxes1: Tensor of shape `(M, 4)` giving a set of box co-ordinates.
        boxes2: Tensor of shape `(N, 4)` giving another set of box co-ordinates.

    Returns:
        torch.Tensor
            Tensor of shape (M, N) with `iou[i, j]` giving IoU between i-th box
            in `boxes1` and j-th box in `boxes2`.
    """

    ##########################################################################
    # TODO: Implement the IoU function here.   
    # Hint: You can  use torch.max and torch.min here  
    # Remember to account for the case that the boxes do not intersect
    # You may use a for loop if necessary, but vectorized code is always better
    ##########################################################################
    # Replace "pass" statement with your code
    
    boxes1_area = (boxes1[:, 2] - boxes1[:, 0]) * (boxes1[:, 3] - boxes1[:, 1])
    boxes1_area = boxes1_area.reshape(boxes1.shape[0], 1)

    boxes2_area = (boxes2[:, 2] - boxes2[:, 0]) * (boxes2[:, 3] - boxes2[:, 1])
    boxes2_area = boxes2_area.reshape(1, boxes2.shape[0])

    area_sum = boxes1_area + boxes2_area

    x_intersection_left = torch.max(boxes1[:, 0].reshape(boxes1.shape[0], 1), boxes2[:, 0])
    x_intersection_right = torch.min(boxes1[:, 2].reshape(boxes1.shape[0], 1), boxes2[:, 2])
    y_intersection_top = torch.max(boxes1[:, 1].reshape(boxes1.shape[0], 1), boxes2[:, 1])
    y_intersection_bottom = torch.min(boxes1[:, 3].reshape(boxes1.shape[0], 1), boxes2[:, 3])

    intersection_x_delta = (x_intersection_right - x_intersection_left)
    intersection_x_delta[intersection_x_delta < 0] = 0
    intersection_y_delta = (y_intersection_bottom - y_intersection_top)
    intersection_y_delta[intersection_y_delta < 0] = 0
    intersection_area = intersection_x_delta * intersection_y_delta

    union_area = area_sum - intersection_area
    iou = intersection_area / union_area

    ##########################################################################
    #                             END OF YOUR CODE                           #
    ##########################################################################
    return iou
```


```python
boxes1 = torch.Tensor([[10, 10, 90, 90], [20, 20, 40, 40], [60, 60, 80, 80]])
boxes2 = torch.Tensor([[10, 10, 90, 90], [60, 60, 80, 80], [30, 30, 70, 70]])

expected_iou = torch.Tensor(
    [[1.0, 0.0625, 0.25], [0.0625, 0.0, 0.052631579], [0.0625, 1.0, 0.052631579]]
)
result_iou = intersection_over_union(boxes1, boxes2)

print("Relative error:", rel_error(expected_iou, result_iou))
```

    Relative error: 0.0


## Non-Maximum Suppression (NMS)

The definition of NMS and instructions on how to compute NMS can be found in the lecture 11 slides (47-48) and discussion 09 slides:
https://www.eecs.umich.edu/courses/eecs442-ahowens/fa22/slides/lec11-object.pdf

Implement the `nms` function given below. We will then compare your implementation of NMS with the implementation in torchvision. Most likely, your implementation will be faster on CPU than on CUDA, and the torchvision implementation will likely be much faster than yours.
This is expected, but your implementation should produce the same outputs as the torchvision version.


```python
def nms(boxes: torch.Tensor, scores: torch.Tensor, iou_threshold: float = 0.5):
    """
    Non-maximum suppression removes overlapping bounding boxes.

    Args:
        boxes: Tensor of shape (N, 4) giving top-left and bottom-right coordinates
            of the bounding boxes to perform NMS on.
        scores: Tensor of shpe (N, ) giving scores for each of the boxes.
        iou_threshold: Discard all overlapping boxes with IoU > iou_threshold

    Returns:
        keep: torch.long tensor with the indices of the elements that have been
            kept by NMS, sorted in decreasing order of scores;
            of shape [num_kept_boxes]
    """

    if (not boxes.numel()) or (not scores.numel()):
        return torch.zeros(0, dtype=torch.long)

    keep = None
    #############################################################################
    # TODO: Implement non-maximum suppression which iterates the following:     #
    #       1. Select the highest-scoring box among the remaining ones,         #
    #          which has not been chosen in this step before                    #
    #       2. Eliminate boxes with IoU > threshold                             #
    #       3. If any boxes remain, GOTO 1                                      #
    #       Your implementation should not depend on a specific device type;    #
    #       you can use the device of the input if necessary.                   #
    # HINT: You can refer to the torchvision library code:                      #
    # github.com/pytorch/vision/blob/main/torchvision/csrc/ops/cpu/nms_kernel.cpp
    #############################################################################
    # Replace "pass" statement with your code
    # keep = []
    # boxes_left = boxes.clone()

    # while (boxes_left.shape[0] != 0):
    #   highest_idx = torch.argmax(scores)
    #   higest_box = boxes[highest_idx]

    #   # boxes = torch.cat((boxes[:highest_idx, :], boxes[highest_idx + 1:, :]), dim = 0)
    #   # scores = torch.cat((scores[:highest_idx], scores[highest_idx + 1:]))

    #   keep.append(highest_idx.item())

    #   threshod_mask = (intersection_over_union(boxes, higest_box.reshape(1, -1)) <= iou_threshold).flatten()
    #   boxes_left = boxes_left[threshod_mask]
    
    # keep = torch.tensor(keep)

    scores_order = scores.sort()[1]
    keep = []

    while (len(scores_order) > 0):
      # print("=========New iter============")
      # print("scores_order: ", scores_order)

      highest_idx = scores_order[-1]
      # print("highest_idx: ", highest_idx)
      keep.append(highest_idx.item())
      # print("keep: ", keep)
      scores_order = scores_order[:-1]
      # print("scores_order: ", scores_order)

      higest_box = boxes[highest_idx]
      threshod_mask = (intersection_over_union(boxes[scores_order], higest_box.reshape(1, -1)) <= iou_threshold).flatten()
      scores_order = scores_order[threshod_mask]
    
    keep = torch.tensor(keep)
    #############################################################################
    #                              END OF YOUR CODE                             #
    #############################################################################
    return keep
```

The difference in your implementation of nms and the nms from the torchvision package should be in the order of `1e-3` or lesser


```python
#Sanity check

reset_seed(0)


boxes = (100.0 * torch.rand(5000, 4)).round()
boxes[:, 2] = boxes[:, 2] + boxes[:, 0] + 1.0
boxes[:, 3] = boxes[:, 3] + boxes[:, 1] + 1.0
scores = torch.randn(5000)

names = ["your_cpu", "torchvision_cpu", "torchvision_cuda"]
iou_thresholds = [0.3, 0.5, 0.7]
elapsed = dict(zip(names, [0.0] * len(names)))
intersects = dict(zip(names[1:], [0.0] * (len(names) - 1)))

for iou_threshold in iou_thresholds:
    tic = time.time()
    my_keep = nms(boxes, scores, iou_threshold)
    elapsed["your_cpu"] += time.time() - tic

    tic = time.time()
    tv_keep = torchvision.ops.nms(boxes, scores, iou_threshold)
    elapsed["torchvision_cpu"] += time.time() - tic
    intersect = len(set(tv_keep.tolist()).intersection(my_keep.tolist())) / len(tv_keep)
    intersects["torchvision_cpu"] += intersect

    tic = time.time()
    tv_cuda_keep = torchvision.ops.nms(boxes.to(device=DEVICE), scores.to(device=DEVICE), iou_threshold).to(
        my_keep.device
    )
    torch.cuda.synchronize()
    elapsed["torchvision_cuda"] += time.time() - tic
    intersect = len(set(tv_cuda_keep.tolist()).intersection(my_keep.tolist())) / len(
        tv_cuda_keep
    )
    intersects["torchvision_cuda"] += intersect

for key in intersects:
    intersects[key] /= len(iou_thresholds)

# You should see < 1% difference
print("Testing NMS:")
print("Your        CPU  implementation: %fs" % elapsed["your_cpu"])
print("torchvision CPU  implementation: %fs" % elapsed["torchvision_cpu"])
print("torchvision CUDA implementation: %fs" % elapsed["torchvision_cuda"])
print("Speedup CPU : %fx" % (elapsed["your_cpu"] / elapsed["torchvision_cpu"]))
print("Speedup CUDA: %fx" % (elapsed["your_cpu"] / elapsed["torchvision_cuda"]))
print(
    "Difference CPU : ", 1.0 - intersects["torchvision_cpu"]
)  # in the order of 1e-3 or less
print(
    "Difference CUDA: ", 1.0 - intersects["torchvision_cuda"]
)  # in the order of 1e-3 or less
```

    Testing NMS:
    Your        CPU  implementation: 1.176934s
    torchvision CPU  implementation: 0.070970s
    torchvision CUDA implementation: 0.009614s
    Speedup CPU : 16.583588x
    Speedup CUDA: 122.418907x
    Difference CPU :  0.0012674271229404788
    Difference CUDA:  0.0


## Mean Average Precision (mAP)

The definition of mAP and instructions on how to compute mAP can be found in the lecture 11 slides (47-48) and discussion 09 slides:
https://www.eecs.umich.edu/courses/eecs442-ahowens/fa22/slides/lec11-object.pdf

Implement the `mean_average_precision` function given below. We will then compare your implementation of mAP with a toy example. Make sure the relative error you get is below 1e-5


```python
def mean_average_precision(
    pred_boxes, true_boxes, iou_threshold=0.5, box_format="midpoint", num_classes=20
):
    """
    Calculates mean average precision 

    Parameters:
        pred_boxes (list): list of lists containing all bboxes with each bboxes
        specified as [train_idx, class_prediction, prob_score, x1, y1, x2, y2]
        true_boxes (list): Similar as pred_boxes except all the correct bounding boxes  
        specified as [train_idx, class_prediction, x1, y1, x2, y2]
        iou_threshold (float): threshold where predicted bboxes is correct
        num_classes (int): number of classes

    Returns:
        float: mAP value across all classes given a specific IoU threshold 
    """

    # list storing all AP for respective classes
    average_precisions = []

    for c in range(num_classes):
      detections = []
      ground_truths = []
      ##########################################################################
      # TODO: Implement the mAP function here.  
      # 1. For each class, find the ground truths and predicted boxes for that class and fill the list detections, ground_truths
      # 2. Sort the predicted boxes by class scores
      # 3. Find the number of ground truth bounding boxes for each image
      # 4. Keep track of all the GT boxes covered. If a predicted box is counted as True Positive based off a particular GT box, 
      #    this GT box should not be matched to any other predicted box thereafter
      # 5. For each detection, calculate IoU with gt boxes of the same image and remember to account for the gt boxes that have already been covered                           
      ##########################################################################

      # Replace "pass" statement with your code
      detections = pred_boxes[pred_boxes[:, 1] == c]
      ground_truths = true_boxes[true_boxes[:, 1] == c]

      total_gt_boxes = ground_truths.shape[0]

      if (total_gt_boxes == 0):
        continue

      confidence_list = []
      match_result = []

      for i in detections[:, 0]:
        detections_in_i = detections[detections[:, 0] == i]
        detections_in_i = detections_in_i[torch.sort(detections_in_i[:, 2], descending = True)[1]]
        gt_in_i = ground_truths[ground_truths[:, 0] == i]

        for detection in detections_in_i:
          detection_box = detection[3:].reshape(1, -1)
          gt_boxes = gt_in_i[:, 2:]

          IOUs = intersection_over_union(gt_boxes, detection_box)
        
          if IOUs.shape[0] > 0:
            max_IOU = torch.max(IOUs, dim = 0)[0]
            max_idx = torch.argmax(IOUs)
          else:
            max_IOU = -1
          
          if (max_IOU > iou_threshold):
            match_result.append(1)
            gt_boxes = torch.concat((gt_boxes[:max_idx, :], gt_boxes[max_idx + 1:, :]))
          else:
            match_result.append(0)

        confidence_list.append(detections_in_i[:, 2].item())

      confidence_list = np.array(confidence_list)

      if (len(confidence_list) == 0):
        continue

      match_result = np.array(match_result)  

      sorted_idx = np.argsort(-confidence_list)
      match_result = match_result[sorted_idx]
      
      tpADDfp = np.arange(1, len(match_result) + 1)
      tpCum = np.cumsum(match_result)
      precisions = torch.tensor(tpCum / tpADDfp)
      recalls = torch.tensor(np.nan_to_num(tpCum / total_gt_boxes))
   
      ##########################################################################
      #                             END OF YOUR CODE                           #
      ##########################################################################
      # precisions - y values, recalls - x values - we append 1 to the precisions since we want to start at 1
      # for numerical intergation and similarly we append 0 to recalls since we want to start at 0 for numerical integration
      precisions = torch.cat((torch.tensor([1]), precisions))
      recalls = torch.cat((torch.tensor([0]), recalls))  
      # torch.trapz for numerical integration
      #We do this to calculate the area under the precision - recall curve
      average_precisions.append(torch.trapz(precisions, recalls))
    map=sum(average_precisions) / len(average_precisions)

    return map
```


```python
pred_boxes = torch.Tensor([[0,0,0.536,258.0, 41.0, 606.0, 285.0],[1,3,0.318,61.0, 22.75, 565.0, 632.42],[1,2,0.725,12.66,3.32,281.26,275.23]])
gt_boxes = torch.Tensor([[0,0,214.0, 41.0, 562.0, 285.0],[1,2,13.00, 22.75, 548.98, 632.42],[1,2,1.66,3.32,270.26,275.23]])
num_classes=20
iou_thresholds=torch.arange(0.5,0.96,0.05)
#iou_thresholds = torch.arange(0.5)

from torchmetrics.detection.mean_ap import MeanAveragePrecision
#MeanAveragePrecision has the foll structure preds=[dict for img1, dict for img2 ....], target=[dict for img1, dict for img2 ....]
preds = [
    dict(
        boxes=torch.tensor([[258.15, 41.29, 606.41, 285.07]]),
         scores=torch.tensor([0.536]),
         labels=torch.tensor([0]),
         ),
    dict(
         boxes=torch.tensor([[61.0, 22.75, 565.0, 632.42],[12.66,3.32,281.26,275.23]]),
         scores=torch.tensor([0.318,0.725]),
         labels=torch.tensor([3,2]),
        )
    ]
target = [
    dict(
        boxes=torch.tensor([[214.15, 41.29, 562.41, 285.07]]),
         labels=torch.tensor([0]),
         ),
    dict(
        boxes=torch.tensor([[13.00, 22.75, 548.98, 632.42],[1.66,3.32,270.26,275.23]]),
         labels=torch.tensor([2,2]),
         )
    ]

metric = MeanAveragePrecision()
metric.update(preds, target)
from pprint import pprint
expected_map=metric.compute()["map"]

result_map=0
for iou_thresh in iou_thresholds:
  iou_thresh=round(iou_thresh.item(),2)
  result_map+=mean_average_precision(pred_boxes=pred_boxes,true_boxes=gt_boxes,num_classes=num_classes,iou_threshold=iou_thresh)
result_map=result_map/iou_thresholds.shape[0]

print("resulting mAP", result_map.item())

print("Relative error:", rel_error(expected_map, result_map))
```

    resulting mAP 0.525
    Relative error: 0.002117127079184053


# Convert Notebook to PDF

[Alternative if the cell below doesn't work.](https://docs.google.com/document/d/1QTutnoApRow8cOxNrKK6ISEkA72QGfwLFXbIcpvarAI/edit?usp=sharing)


```python
import os
from google.colab import drive
from google.colab import files

drive_mount_point = '/content/drive/'
drive.mount(drive_mount_point)
```

    Mounted at /content/drive/



```python
# generate pdf
# Please provide the full path of the notebook file below
# Important: make sure that your file name does not contain spaces!

# Ex: notebookpath = '/content/drive/My Drive/Colab Notebooks/EECS_442_PS4_FA_2022_Starter_Code.ipynb'
#notebookpath = '/content/drive/MyDrive/PS7_FCOS/PS7_EECS_504_part2.ipynb' 
notebookpath = '/content/drive/MyDrive/eecs504/hw7/yjwoo_12105260.ipynb' 

file_name = notebookpath.split('/')[-1]
get_ipython().system("apt update && apt install texlive-xetex texlive-fonts-recommended texlive-generic-recommended")
get_ipython().system("jupyter nbconvert --to PDF {}".format(notebookpath.replace(' ', '\\ ')))
files.download(notebookpath.split('.')[0]+'.pdf')
```

    Get:1 https://cloud.r-project.org/bin/linux/ubuntu bionic-cran40/ InRelease [3,626 B]
    Ign:2 https://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1804/x86_64  InRelease
    Hit:3 https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64  InRelease
    Hit:4 https://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1804/x86_64  Release
    Hit:6 http://archive.ubuntu.com/ubuntu bionic InRelease
    Hit:8 http://ppa.launchpad.net/c2d4u.team/c2d4u4.0+/ubuntu bionic InRelease
    Get:7 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]
    Get:9 http://archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]
    Hit:10 http://ppa.launchpad.net/cran/libgit2/ubuntu bionic InRelease
    Hit:11 http://ppa.launchpad.net/deadsnakes/ppa/ubuntu bionic InRelease
    Get:12 http://archive.ubuntu.com/ubuntu bionic-backports InRelease [83.3 kB]
    Get:13 http://security.ubuntu.com/ubuntu bionic-security/universe amd64 Packages [1,554 kB]
    Get:14 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages [3,040 kB]
    Hit:15 http://ppa.launchpad.net/graphics-drivers/ppa/ubuntu bionic InRelease
    Get:16 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 Packages [2,332 kB]
    Get:17 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages [3,472 kB]
    Fetched 8,890 kB in 5s (1,806 kB/s)
    Reading package lists... Done
    Building dependency tree       
    Reading state information... Done
    5 packages can be upgraded. Run 'apt list --upgradable' to see them.
    Reading package lists... Done
    Building dependency tree       
    Reading state information... Done
    The following package was automatically installed and is no longer required:
      libnvidia-common-460
    Use 'apt autoremove' to remove it.
    The following additional packages will be installed:
      fonts-droid-fallback fonts-lato fonts-lmodern fonts-noto-mono fonts-texgyre
      javascript-common libcupsfilters1 libcupsimage2 libgs9 libgs9-common
      libijs-0.35 libjbig2dec0 libjs-jquery libkpathsea6 libpotrace0 libptexenc1
      libruby2.5 libsynctex1 libtexlua52 libtexluajit2 libzzip-0-13 lmodern
      poppler-data preview-latex-style rake ruby ruby-did-you-mean ruby-minitest
      ruby-net-telnet ruby-power-assert ruby-test-unit ruby2.5
      rubygems-integration t1utils tex-common tex-gyre texlive-base
      texlive-binaries texlive-latex-base texlive-latex-extra
      texlive-latex-recommended texlive-pictures texlive-plain-generic tipa
    Suggested packages:
      fonts-noto apache2 | lighttpd | httpd poppler-utils ghostscript
      fonts-japanese-mincho | fonts-ipafont-mincho fonts-japanese-gothic
      | fonts-ipafont-gothic fonts-arphic-ukai fonts-arphic-uming fonts-nanum ri
      ruby-dev bundler debhelper gv | postscript-viewer perl-tk xpdf-reader
      | pdf-viewer texlive-fonts-recommended-doc texlive-latex-base-doc
      python-pygments icc-profiles libfile-which-perl
      libspreadsheet-parseexcel-perl texlive-latex-extra-doc
      texlive-latex-recommended-doc texlive-pstricks dot2tex prerex ruby-tcltk
      | libtcltk-ruby texlive-pictures-doc vprerex
    The following NEW packages will be installed:
      fonts-droid-fallback fonts-lato fonts-lmodern fonts-noto-mono fonts-texgyre
      javascript-common libcupsfilters1 libcupsimage2 libgs9 libgs9-common
      libijs-0.35 libjbig2dec0 libjs-jquery libkpathsea6 libpotrace0 libptexenc1
      libruby2.5 libsynctex1 libtexlua52 libtexluajit2 libzzip-0-13 lmodern
      poppler-data preview-latex-style rake ruby ruby-did-you-mean ruby-minitest
      ruby-net-telnet ruby-power-assert ruby-test-unit ruby2.5
      rubygems-integration t1utils tex-common tex-gyre texlive-base
      texlive-binaries texlive-fonts-recommended texlive-generic-recommended
      texlive-latex-base texlive-latex-extra texlive-latex-recommended
      texlive-pictures texlive-plain-generic texlive-xetex tipa
    0 upgraded, 47 newly installed, 0 to remove and 5 not upgraded.
    Need to get 146 MB of archives.
    After this operation, 460 MB of additional disk space will be used.
    Get:1 http://archive.ubuntu.com/ubuntu bionic/main amd64 fonts-droid-fallback all 1:6.0.1r16-1.1 [1,805 kB]
    Get:2 http://archive.ubuntu.com/ubuntu bionic/main amd64 fonts-lato all 2.0-2 [2,698 kB]
    Get:3 http://archive.ubuntu.com/ubuntu bionic/main amd64 poppler-data all 0.4.8-2 [1,479 kB]
    Get:4 http://archive.ubuntu.com/ubuntu bionic/main amd64 tex-common all 6.09 [33.0 kB]
    Get:5 http://archive.ubuntu.com/ubuntu bionic/main amd64 fonts-lmodern all 2.004.5-3 [4,551 kB]
    Get:6 http://archive.ubuntu.com/ubuntu bionic/main amd64 fonts-noto-mono all 20171026-2 [75.5 kB]
    Get:7 http://archive.ubuntu.com/ubuntu bionic/universe amd64 fonts-texgyre all 20160520-1 [8,761 kB]
    Get:8 http://archive.ubuntu.com/ubuntu bionic/main amd64 javascript-common all 11 [6,066 B]
    Get:9 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libcupsfilters1 amd64 1.20.2-0ubuntu3.1 [108 kB]
    Get:10 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libcupsimage2 amd64 2.2.7-1ubuntu2.9 [18.6 kB]
    Get:11 http://archive.ubuntu.com/ubuntu bionic/main amd64 libijs-0.35 amd64 0.35-13 [15.5 kB]
    Get:12 http://archive.ubuntu.com/ubuntu bionic/main amd64 libjbig2dec0 amd64 0.13-6 [55.9 kB]
    Get:13 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libgs9-common all 9.26~dfsg+0-0ubuntu0.18.04.17 [5,092 kB]
    Get:14 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libgs9 amd64 9.26~dfsg+0-0ubuntu0.18.04.17 [2,267 kB]
    Get:15 http://archive.ubuntu.com/ubuntu bionic/main amd64 libjs-jquery all 3.2.1-1 [152 kB]
    Get:16 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libkpathsea6 amd64 2017.20170613.44572-8ubuntu0.1 [54.9 kB]
    Get:17 http://archive.ubuntu.com/ubuntu bionic/main amd64 libpotrace0 amd64 1.14-2 [17.4 kB]
    Get:18 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libptexenc1 amd64 2017.20170613.44572-8ubuntu0.1 [34.5 kB]
    Get:19 http://archive.ubuntu.com/ubuntu bionic/main amd64 rubygems-integration all 1.11 [4,994 B]
    Get:20 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 ruby2.5 amd64 2.5.1-1ubuntu1.12 [48.6 kB]
    Get:21 http://archive.ubuntu.com/ubuntu bionic/main amd64 ruby amd64 1:2.5.1 [5,712 B]
    Get:22 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 rake all 12.3.1-1ubuntu0.1 [44.9 kB]
    Get:23 http://archive.ubuntu.com/ubuntu bionic/main amd64 ruby-did-you-mean all 1.2.0-2 [9,700 B]
    Get:24 http://archive.ubuntu.com/ubuntu bionic/main amd64 ruby-minitest all 5.10.3-1 [38.6 kB]
    Get:25 http://archive.ubuntu.com/ubuntu bionic/main amd64 ruby-net-telnet all 0.1.1-2 [12.6 kB]
    Get:26 http://archive.ubuntu.com/ubuntu bionic/main amd64 ruby-power-assert all 0.3.0-1 [7,952 B]
    Get:27 http://archive.ubuntu.com/ubuntu bionic/main amd64 ruby-test-unit all 3.2.5-1 [61.1 kB]
    Get:28 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libruby2.5 amd64 2.5.1-1ubuntu1.12 [3,073 kB]
    Get:29 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libsynctex1 amd64 2017.20170613.44572-8ubuntu0.1 [41.4 kB]
    Get:30 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libtexlua52 amd64 2017.20170613.44572-8ubuntu0.1 [91.2 kB]
    Get:31 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libtexluajit2 amd64 2017.20170613.44572-8ubuntu0.1 [230 kB]
    Get:32 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 libzzip-0-13 amd64 0.13.62-3.1ubuntu0.18.04.1 [26.0 kB]
    Get:33 http://archive.ubuntu.com/ubuntu bionic/main amd64 lmodern all 2.004.5-3 [9,631 kB]
    Get:34 http://archive.ubuntu.com/ubuntu bionic/main amd64 preview-latex-style all 11.91-1ubuntu1 [185 kB]
    Get:35 http://archive.ubuntu.com/ubuntu bionic/main amd64 t1utils amd64 1.41-2 [56.0 kB]
    Get:36 http://archive.ubuntu.com/ubuntu bionic/universe amd64 tex-gyre all 20160520-1 [4,998 kB]
    Get:37 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 texlive-binaries amd64 2017.20170613.44572-8ubuntu0.1 [8,179 kB]
    Get:38 http://archive.ubuntu.com/ubuntu bionic/main amd64 texlive-base all 2017.20180305-1 [18.7 MB]
    Get:39 http://archive.ubuntu.com/ubuntu bionic/universe amd64 texlive-fonts-recommended all 2017.20180305-1 [5,262 kB]
    Get:40 http://archive.ubuntu.com/ubuntu bionic/universe amd64 texlive-plain-generic all 2017.20180305-2 [23.6 MB]
    Get:41 http://archive.ubuntu.com/ubuntu bionic/universe amd64 texlive-generic-recommended all 2017.20180305-1 [15.9 kB]
    Get:42 http://archive.ubuntu.com/ubuntu bionic/main amd64 texlive-latex-base all 2017.20180305-1 [951 kB]
    Get:43 http://archive.ubuntu.com/ubuntu bionic/main amd64 texlive-latex-recommended all 2017.20180305-1 [14.9 MB]
    Get:44 http://archive.ubuntu.com/ubuntu bionic/universe amd64 texlive-pictures all 2017.20180305-1 [4,026 kB]
    Get:45 http://archive.ubuntu.com/ubuntu bionic/universe amd64 texlive-latex-extra all 2017.20180305-2 [10.6 MB]
    Get:46 http://archive.ubuntu.com/ubuntu bionic/universe amd64 tipa all 2:1.3-20 [2,978 kB]
    Get:47 http://archive.ubuntu.com/ubuntu bionic/universe amd64 texlive-xetex all 2017.20180305-1 [10.7 MB]
    Fetched 146 MB in 16s (9,177 kB/s)
    Extracting templates from packages: 100%
    Preconfiguring packages ...
    Selecting previously unselected package fonts-droid-fallback.
    (Reading database ... 123942 files and directories currently installed.)
    Preparing to unpack .../00-fonts-droid-fallback_1%3a6.0.1r16-1.1_all.deb ...
    Unpacking fonts-droid-fallback (1:6.0.1r16-1.1) ...
    Selecting previously unselected package fonts-lato.
    Preparing to unpack .../01-fonts-lato_2.0-2_all.deb ...
    Unpacking fonts-lato (2.0-2) ...
    Selecting previously unselected package poppler-data.
    Preparing to unpack .../02-poppler-data_0.4.8-2_all.deb ...
    Unpacking poppler-data (0.4.8-2) ...
    Selecting previously unselected package tex-common.
    Preparing to unpack .../03-tex-common_6.09_all.deb ...
    Unpacking tex-common (6.09) ...
    Selecting previously unselected package fonts-lmodern.
    Preparing to unpack .../04-fonts-lmodern_2.004.5-3_all.deb ...
    Unpacking fonts-lmodern (2.004.5-3) ...
    Selecting previously unselected package fonts-noto-mono.
    Preparing to unpack .../05-fonts-noto-mono_20171026-2_all.deb ...
    Unpacking fonts-noto-mono (20171026-2) ...
    Selecting previously unselected package fonts-texgyre.
    Preparing to unpack .../06-fonts-texgyre_20160520-1_all.deb ...
    Unpacking fonts-texgyre (20160520-1) ...
    Selecting previously unselected package javascript-common.
    Preparing to unpack .../07-javascript-common_11_all.deb ...
    Unpacking javascript-common (11) ...
    Selecting previously unselected package libcupsfilters1:amd64.
    Preparing to unpack .../08-libcupsfilters1_1.20.2-0ubuntu3.1_amd64.deb ...
    Unpacking libcupsfilters1:amd64 (1.20.2-0ubuntu3.1) ...
    Selecting previously unselected package libcupsimage2:amd64.
    Preparing to unpack .../09-libcupsimage2_2.2.7-1ubuntu2.9_amd64.deb ...
    Unpacking libcupsimage2:amd64 (2.2.7-1ubuntu2.9) ...
    Selecting previously unselected package libijs-0.35:amd64.
    Preparing to unpack .../10-libijs-0.35_0.35-13_amd64.deb ...
    Unpacking libijs-0.35:amd64 (0.35-13) ...
    Selecting previously unselected package libjbig2dec0:amd64.
    Preparing to unpack .../11-libjbig2dec0_0.13-6_amd64.deb ...
    Unpacking libjbig2dec0:amd64 (0.13-6) ...
    Selecting previously unselected package libgs9-common.
    Preparing to unpack .../12-libgs9-common_9.26~dfsg+0-0ubuntu0.18.04.17_all.deb ...
    Unpacking libgs9-common (9.26~dfsg+0-0ubuntu0.18.04.17) ...
    Selecting previously unselected package libgs9:amd64.
    Preparing to unpack .../13-libgs9_9.26~dfsg+0-0ubuntu0.18.04.17_amd64.deb ...
    Unpacking libgs9:amd64 (9.26~dfsg+0-0ubuntu0.18.04.17) ...
    Selecting previously unselected package libjs-jquery.
    Preparing to unpack .../14-libjs-jquery_3.2.1-1_all.deb ...
    Unpacking libjs-jquery (3.2.1-1) ...
    Selecting previously unselected package libkpathsea6:amd64.
    Preparing to unpack .../15-libkpathsea6_2017.20170613.44572-8ubuntu0.1_amd64.deb ...
    Unpacking libkpathsea6:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Selecting previously unselected package libpotrace0.
    Preparing to unpack .../16-libpotrace0_1.14-2_amd64.deb ...
    Unpacking libpotrace0 (1.14-2) ...
    Selecting previously unselected package libptexenc1:amd64.
    Preparing to unpack .../17-libptexenc1_2017.20170613.44572-8ubuntu0.1_amd64.deb ...
    Unpacking libptexenc1:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Selecting previously unselected package rubygems-integration.
    Preparing to unpack .../18-rubygems-integration_1.11_all.deb ...
    Unpacking rubygems-integration (1.11) ...
    Selecting previously unselected package ruby2.5.
    Preparing to unpack .../19-ruby2.5_2.5.1-1ubuntu1.12_amd64.deb ...
    Unpacking ruby2.5 (2.5.1-1ubuntu1.12) ...
    Selecting previously unselected package ruby.
    Preparing to unpack .../20-ruby_1%3a2.5.1_amd64.deb ...
    Unpacking ruby (1:2.5.1) ...
    Selecting previously unselected package rake.
    Preparing to unpack .../21-rake_12.3.1-1ubuntu0.1_all.deb ...
    Unpacking rake (12.3.1-1ubuntu0.1) ...
    Selecting previously unselected package ruby-did-you-mean.
    Preparing to unpack .../22-ruby-did-you-mean_1.2.0-2_all.deb ...
    Unpacking ruby-did-you-mean (1.2.0-2) ...
    Selecting previously unselected package ruby-minitest.
    Preparing to unpack .../23-ruby-minitest_5.10.3-1_all.deb ...
    Unpacking ruby-minitest (5.10.3-1) ...
    Selecting previously unselected package ruby-net-telnet.
    Preparing to unpack .../24-ruby-net-telnet_0.1.1-2_all.deb ...
    Unpacking ruby-net-telnet (0.1.1-2) ...
    Selecting previously unselected package ruby-power-assert.
    Preparing to unpack .../25-ruby-power-assert_0.3.0-1_all.deb ...
    Unpacking ruby-power-assert (0.3.0-1) ...
    Selecting previously unselected package ruby-test-unit.
    Preparing to unpack .../26-ruby-test-unit_3.2.5-1_all.deb ...
    Unpacking ruby-test-unit (3.2.5-1) ...
    Selecting previously unselected package libruby2.5:amd64.
    Preparing to unpack .../27-libruby2.5_2.5.1-1ubuntu1.12_amd64.deb ...
    Unpacking libruby2.5:amd64 (2.5.1-1ubuntu1.12) ...
    Selecting previously unselected package libsynctex1:amd64.
    Preparing to unpack .../28-libsynctex1_2017.20170613.44572-8ubuntu0.1_amd64.deb ...
    Unpacking libsynctex1:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Selecting previously unselected package libtexlua52:amd64.
    Preparing to unpack .../29-libtexlua52_2017.20170613.44572-8ubuntu0.1_amd64.deb ...
    Unpacking libtexlua52:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Selecting previously unselected package libtexluajit2:amd64.
    Preparing to unpack .../30-libtexluajit2_2017.20170613.44572-8ubuntu0.1_amd64.deb ...
    Unpacking libtexluajit2:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Selecting previously unselected package libzzip-0-13:amd64.
    Preparing to unpack .../31-libzzip-0-13_0.13.62-3.1ubuntu0.18.04.1_amd64.deb ...
    Unpacking libzzip-0-13:amd64 (0.13.62-3.1ubuntu0.18.04.1) ...
    Selecting previously unselected package lmodern.
    Preparing to unpack .../32-lmodern_2.004.5-3_all.deb ...
    Unpacking lmodern (2.004.5-3) ...
    Selecting previously unselected package preview-latex-style.
    Preparing to unpack .../33-preview-latex-style_11.91-1ubuntu1_all.deb ...
    Unpacking preview-latex-style (11.91-1ubuntu1) ...
    Selecting previously unselected package t1utils.
    Preparing to unpack .../34-t1utils_1.41-2_amd64.deb ...
    Unpacking t1utils (1.41-2) ...
    Selecting previously unselected package tex-gyre.
    Preparing to unpack .../35-tex-gyre_20160520-1_all.deb ...
    Unpacking tex-gyre (20160520-1) ...
    Selecting previously unselected package texlive-binaries.
    Preparing to unpack .../36-texlive-binaries_2017.20170613.44572-8ubuntu0.1_amd64.deb ...
    Unpacking texlive-binaries (2017.20170613.44572-8ubuntu0.1) ...
    Selecting previously unselected package texlive-base.
    Preparing to unpack .../37-texlive-base_2017.20180305-1_all.deb ...
    Unpacking texlive-base (2017.20180305-1) ...
    Selecting previously unselected package texlive-fonts-recommended.
    Preparing to unpack .../38-texlive-fonts-recommended_2017.20180305-1_all.deb ...
    Unpacking texlive-fonts-recommended (2017.20180305-1) ...
    Selecting previously unselected package texlive-plain-generic.
    Preparing to unpack .../39-texlive-plain-generic_2017.20180305-2_all.deb ...
    Unpacking texlive-plain-generic (2017.20180305-2) ...
    Selecting previously unselected package texlive-generic-recommended.
    Preparing to unpack .../40-texlive-generic-recommended_2017.20180305-1_all.deb ...
    Unpacking texlive-generic-recommended (2017.20180305-1) ...
    Selecting previously unselected package texlive-latex-base.
    Preparing to unpack .../41-texlive-latex-base_2017.20180305-1_all.deb ...
    Unpacking texlive-latex-base (2017.20180305-1) ...
    Selecting previously unselected package texlive-latex-recommended.
    Preparing to unpack .../42-texlive-latex-recommended_2017.20180305-1_all.deb ...
    Unpacking texlive-latex-recommended (2017.20180305-1) ...
    Selecting previously unselected package texlive-pictures.
    Preparing to unpack .../43-texlive-pictures_2017.20180305-1_all.deb ...
    Unpacking texlive-pictures (2017.20180305-1) ...
    Selecting previously unselected package texlive-latex-extra.
    Preparing to unpack .../44-texlive-latex-extra_2017.20180305-2_all.deb ...
    Unpacking texlive-latex-extra (2017.20180305-2) ...
    Selecting previously unselected package tipa.
    Preparing to unpack .../45-tipa_2%3a1.3-20_all.deb ...
    Unpacking tipa (2:1.3-20) ...
    Selecting previously unselected package texlive-xetex.
    Preparing to unpack .../46-texlive-xetex_2017.20180305-1_all.deb ...
    Unpacking texlive-xetex (2017.20180305-1) ...
    Setting up libgs9-common (9.26~dfsg+0-0ubuntu0.18.04.17) ...
    Setting up libkpathsea6:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Setting up libjs-jquery (3.2.1-1) ...
    Setting up libtexlua52:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Setting up fonts-droid-fallback (1:6.0.1r16-1.1) ...
    Setting up libsynctex1:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Setting up libptexenc1:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Setting up tex-common (6.09) ...
    update-language: texlive-base not installed and configured, doing nothing!
    Setting up poppler-data (0.4.8-2) ...
    Setting up tex-gyre (20160520-1) ...
    Setting up preview-latex-style (11.91-1ubuntu1) ...
    Setting up fonts-texgyre (20160520-1) ...
    Setting up fonts-noto-mono (20171026-2) ...
    Setting up fonts-lato (2.0-2) ...
    Setting up libcupsfilters1:amd64 (1.20.2-0ubuntu3.1) ...
    Setting up libcupsimage2:amd64 (2.2.7-1ubuntu2.9) ...
    Setting up libjbig2dec0:amd64 (0.13-6) ...
    Setting up ruby-did-you-mean (1.2.0-2) ...
    Setting up t1utils (1.41-2) ...
    Setting up ruby-net-telnet (0.1.1-2) ...
    Setting up libijs-0.35:amd64 (0.35-13) ...
    Setting up rubygems-integration (1.11) ...
    Setting up libpotrace0 (1.14-2) ...
    Setting up javascript-common (11) ...
    Setting up ruby-minitest (5.10.3-1) ...
    Setting up libzzip-0-13:amd64 (0.13.62-3.1ubuntu0.18.04.1) ...
    Setting up libgs9:amd64 (9.26~dfsg+0-0ubuntu0.18.04.17) ...
    Setting up libtexluajit2:amd64 (2017.20170613.44572-8ubuntu0.1) ...
    Setting up fonts-lmodern (2.004.5-3) ...
    Setting up ruby-power-assert (0.3.0-1) ...
    Setting up texlive-binaries (2017.20170613.44572-8ubuntu0.1) ...
    update-alternatives: using /usr/bin/xdvi-xaw to provide /usr/bin/xdvi.bin (xdvi.bin) in auto mode
    update-alternatives: using /usr/bin/bibtex.original to provide /usr/bin/bibtex (bibtex) in auto mode
    Setting up texlive-base (2017.20180305-1) ...
    mktexlsr: Updating /var/lib/texmf/ls-R-TEXLIVEDIST... 
    mktexlsr: Updating /var/lib/texmf/ls-R-TEXMFMAIN... 
    mktexlsr: Updating /var/lib/texmf/ls-R... 
    mktexlsr: Done.
    tl-paper: setting paper size for dvips to a4: /var/lib/texmf/dvips/config/config-paper.ps
    tl-paper: setting paper size for dvipdfmx to a4: /var/lib/texmf/dvipdfmx/dvipdfmx-paper.cfg
    tl-paper: setting paper size for xdvi to a4: /var/lib/texmf/xdvi/XDvi-paper
    tl-paper: setting paper size for pdftex to a4: /var/lib/texmf/tex/generic/config/pdftexconfig.tex
    Setting up texlive-fonts-recommended (2017.20180305-1) ...
    Setting up texlive-plain-generic (2017.20180305-2) ...
    Setting up texlive-generic-recommended (2017.20180305-1) ...
    Setting up texlive-latex-base (2017.20180305-1) ...
    Setting up lmodern (2.004.5-3) ...
    Setting up texlive-latex-recommended (2017.20180305-1) ...
    Setting up texlive-pictures (2017.20180305-1) ...
    Setting up tipa (2:1.3-20) ...
    Regenerating '/var/lib/texmf/fmtutil.cnf-DEBIAN'... done.
    Regenerating '/var/lib/texmf/fmtutil.cnf-TEXLIVEDIST'... done.
    update-fmtutil has updated the following file(s):
    	/var/lib/texmf/fmtutil.cnf-DEBIAN
    	/var/lib/texmf/fmtutil.cnf-TEXLIVEDIST
    If you want to activate the changes in the above file(s),
    you should run fmtutil-sys or fmtutil.
    Setting up texlive-latex-extra (2017.20180305-2) ...
    Setting up texlive-xetex (2017.20180305-1) ...
    Setting up ruby2.5 (2.5.1-1ubuntu1.12) ...
    Setting up ruby (1:2.5.1) ...
    Setting up ruby-test-unit (3.2.5-1) ...
    Setting up rake (12.3.1-1ubuntu0.1) ...
    Setting up libruby2.5:amd64 (2.5.1-1ubuntu1.12) ...
    Processing triggers for mime-support (3.60ubuntu1) ...
    Processing triggers for libc-bin (2.27-3ubuntu1.6) ...
    Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
    Processing triggers for fontconfig (2.12.6-0ubuntu2) ...
    Processing triggers for tex-common (6.09) ...
    Running updmap-sys. This may take some time... done.
    Running mktexlsr /var/lib/texmf ... done.
    Building format(s) --all.
    	This may take some time... done.
    [NbConvertApp] Converting notebook /content/drive/MyDrive/eecs504/hw7/yjwoo_12105260.ipynb to PDF
    [NbConvertApp] Writing 93664 bytes to ./notebook.tex
    [NbConvertApp] Building PDF
    [NbConvertApp] Running xelatex 3 times: ['xelatex', './notebook.tex', '-quiet']
    [NbConvertApp] Running bibtex 1 time: ['bibtex', './notebook']
    [NbConvertApp] WARNING | bibtex had problems, most likely because there were no citations
    [NbConvertApp] PDF successfully created
    [NbConvertApp] Writing 87977 bytes to /content/drive/MyDrive/eecs504/hw7/yjwoo_12105260.pdf



    <IPython.core.display.Javascript object>



    <IPython.core.display.Javascript object>

